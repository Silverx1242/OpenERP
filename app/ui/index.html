<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenPYME ERP</title>
    <!-- 1. Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Carga de Chart.js para los KPIs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 3. Configuraci칩n de Tailwind (para colores de Google/Gemini) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gemini-blue': {
                            light: '#e8f0fe',
                            DEFAULT: '#4285f4', // Azul principal de Google
                            dark: '#174ea6',
                        },
                        'gemini-gray': {
                            100: '#f8f9fa',
                            200: '#e9ecef',
                            300: '#dee2e6',
                            700: '#495057',
                            900: '#212529',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Fuente limpia
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilo para la barra de scroll */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0b8c3; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gemini-gray-100 text-gemini-gray-900">

    <!-- Contenedor principal de la aplicaci칩n -->
    <div class="flex h-screen">

        <!-- Barra lateral de navegaci칩n -->
        <nav class="w-48 md:w-56 bg-white shadow-md flex flex-col flex-shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-xl font-bold text-gemini-blue-dark">OpenPYME ERP</h1>
            </div>
            <ul class="flex-grow p-2">
                <li class="mb-1">
                    <a href="#" onclick="showView('dashboard')" class="nav-link active flex items-center p-2 rounded-lg hover:bg-gemini-blue-light text-gemini-blue-dark font-medium">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                </li>
                <li class="mb-1">
                    <a href="#" onclick="showView('inventory')" class="nav-link flex items-center p-2 rounded-lg hover:bg-gemini-blue-light">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        Inventario
                    </a>
                </li>
                <li class="mb-1">
                    <a href="#" onclick="showView('mrp')" class="nav-link flex items-center p-2 rounded-lg hover:bg-gemini-blue-light">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 0l3 3m-3-3v10m-6 4h6m-6 0l-3-3m3 3V7m0 14A10 10 0 115.636 5.636 10 10 0 0112 3v18z"></path></svg>
                        Producci칩n y MRP
                    </a>
                </li>
                <!-- 춰NUEVO! Enlace de Finanzas -->
                <li class="mb-1">
                    <a href="#" onclick="showView('finanzas')" class="nav-link flex items-center p-2 rounded-lg hover:bg-gemini-blue-light">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2 1.343-2 3-2m0 8c1.11 0 2.08-.402 2.599-1M12 16v1m0-1v-8m0 0c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0 8c1.11 0 2.08.402 2.599 1M12 4V3m0 1v4m0 0c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0 8a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        Finanzas
                    </a>
                </li>
            </ul>
            <div class="p-4 border-t">
                <button onclick="exportToExcel()" class="w-full bg-gemini-blue hover:bg-gemini-blue-dark text-white font-bold py-2 px-4 rounded-lg transition duration-200 mb-2">
                    Exportar a Excel
                </button>
                <button onclick="openLastExcelFile()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Ver Excel
                </button>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="flex-1 h-screen overflow-y-auto p-4 md:p-8">
            
            <!-- Vista: Dashboard -->
            <div id="view-dashboard" class="view-content">
                <h2 class="text-3xl font-semibold mb-6">Dashboard - Inteligencia de Negocios</h2>
                
                <!-- M칠tricas Financieras R치pidas -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Margen de Ganancia</div>
                        <div id="kpi-profit-margin" class="text-2xl font-bold text-green-600">0%</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Ticket Promedio</div>
                        <div id="kpi-avg-ticket" class="text-2xl font-bold text-gemini-blue-dark">$ 0.00</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Ventas del Mes</div>
                        <div id="kpi-sales-count" class="text-2xl font-bold text-purple-600">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Utilidad del Mes</div>
                        <div id="kpi-month-profit" class="text-2xl font-bold text-green-600">$ 0.00</div>
                    </div>
                </div>

                <!-- KPIs de Inventario -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Valor Total del Inventario</div>
                        <div id="kpi-inventory-value" class="text-xl font-bold text-gemini-blue-dark">$ 0.00</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Nivel de Stock (Total Items)</div>
                        <div id="kpi-total-stock" class="text-xl font-bold text-gemini-blue-dark">0</div>
                    </div>
                </div>

                <!-- Productos con Alerta de Stock -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="font-semibold mb-4 text-lg text-red-700">丘멆잺 Productos con Alerta de Stock Bajo</h3>
                    <div id="stock-alerts-list" class="space-y-2">
                        <p class="text-gray-500">Cargando...</p>
                    </div>
                </div>

                <!-- Gr치fico Principal de Finanzas -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">Ingresos, Costos y Utilidades</h3>
                            <select id="period-selector" class="text-sm rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <option value="day">Diario</option>
                                <option value="week">Semanal</option>
                                <option value="month" selected>Mensual</option>
                                <option value="year">Anual</option>
                            </select>
                        </div>
                    <canvas id="kpiChart" height="80"></canvas>
                    </div>

                <!-- Top Productos y Desglose de Gastos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Top 5 Productos M치s Vendidos -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Top 5 Productos M치s Vendidos</h3>
                        <canvas id="topSalesChart" height="200"></canvas>
                            </div>
                    
                    <!-- Top 5 Productos M치s Rentables -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Top 5 Productos M치s Rentables</h3>
                        <div id="topProfitabilityList" class="space-y-2">
                            <!-- Se llenar치 con JS -->
                            </div>
                            </div>
                        </div>

                <!-- Desglose de Gastos y Salud del Inventario -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Desglose de Gastos por Categor칤a -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Desglose de Gastos por Categor칤a</h3>
                        <canvas id="costBreakdownChart" height="200"></canvas>
                    </div>
                    
                    <!-- Valorizaci칩n del Inventario por Categor칤a -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Valorizaci칩n del Inventario por Categor칤a</h3>
                        <canvas id="inventoryValuationChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Productos Sin Movimiento -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="font-semibold mb-4 text-lg">Productos Sin Movimiento (칔ltimos 30 d칤as)</h3>
                    <div id="productsNoMovementList" class="space-y-2">
                        <!-- Se llenar치 con JS -->
                    </div>
                </div>

            </div>

            <!-- Vista: Inventario -->
            <div id="view-inventory" class="view-content hidden">
                <h2 class="text-3xl font-semibold mb-6">Gesti칩n de Inventario</h2>
                
                <!-- Formulario para a침adir producto -->
                <div class="bg-white p-4 md:p-6 rounded-lg shadow mb-6 md:mb-8">
                    <h3 class="font-semibold mb-4 text-lg md:text-xl">A침adir Nuevo Producto</h3>
                    <!-- 춰MODIFICADO! Grid con m치s campos -->
                    <form id="form-add-product" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                        <div>
                            <label for="product_sku" class="block text-sm font-medium text-gemini-gray-700">SKU / ID</label>
                            <input type="text" id="product_sku" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="C칩digo SKU">
                        </div>
                        <div class="md:col-span-2">
                            <label for="product_name" class="block text-sm font-medium text-gemini-gray-700">Nombre</label>
                            <input type="text" id="product_name" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                        </div>
                        <div>
                            <label for="product_type" class="block text-sm font-medium text-gemini-gray-700">Tipo de Producto</label>
                            <select id="product_type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <option value="hijo">Insumo / Hijo</option>
                                <option value="final">Producto Final</option>
                                <option value="padre">Sub-ensamblaje / Padre</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div>
                            <label for="product_supplier" class="block text-sm font-medium text-gemini-gray-700">Proveedor</label>
                            <input type="text" id="product_supplier" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Nombre del proveedor">
                        </div>
                        <div>
                            <label for="product_cost" class="block text-sm font-medium text-gemini-gray-700">Costo Unitario</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="product_cost" value="0" step="0.01" class="mt-1 block flex-1 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <button type="button" onclick="calculateCostFromBOM()" class="mt-1 text-xs bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Calcular costo basado en BOM">游눯 Calcular</button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500" id="cost-calculation-hint">Costo final = Costo de materiales + Costo adicional</p>
                        </div>
                        <div>
                            <label for="product_additional_cost" class="block text-sm font-medium text-gemini-gray-700">Costo Adicional</label>
                            <input type="number" id="product_additional_cost" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500">Costos adicionales (mano de obra, overhead, etc.) que se suman al costo de materiales</p>
                        </div>
                        <div>
                            <label for="product_stock" class="block text-sm font-medium text-gemini-gray-700">Stock Inicial</label>
                            <input type="number" id="product_stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500" id="stock-unit-hint">En unidades o gramos seg칰n el tipo seleccionado</p>
                        </div>
                        <div>
                            <label for="product_min_stock" class="block text-sm font-medium text-gemini-gray-700">Stock M칤nimo</label>
                            <input type="number" id="product_min_stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500" id="min-stock-unit-hint">En unidades o gramos seg칰n el tipo seleccionado</p>
                        </div>
                        <div>
                            <label for="product_purchase_date" class="block text-sm font-medium text-gemini-gray-700">Fecha de Compra</label>
                            <input type="date" id="product_purchase_date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        </div>
                        <div>
                            <label for="product_exit_date" class="block text-sm font-medium text-gemini-gray-700">Fecha de Salida</label>
                            <input type="date" id="product_exit_date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        </div>
                        <div>
                            <label for="product_stock_unit_type" class="block text-sm font-medium text-gemini-gray-700">Tipo de Medici칩n de Stock</label>
                            <select id="product_stock_unit_type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" onchange="updateStockUnitHints()">
                                <option value="units">Unidades</option>
                                <option value="grams">Gramos</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Unidades: cuenta por piezas. Gramos: cuenta por peso.</p>
                        </div>
                        <div>
                            <label for="product_weight" class="block text-sm font-medium text-gemini-gray-700">Gramaje por Unidad (g)</label>
                            <input type="number" id="product_weight" value="0" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Gramos por unidad">
                            <p class="mt-1 text-xs text-gray-500">Solo aplica si el stock se mide en unidades.</p>
                        </div>
                        <div class="md:col-span-2 lg:col-span-4 flex justify-end">
                            <button type="submit" class="w-full md:w-auto bg-gemini-blue hover:bg-gemini-blue-dark text-white font-bold py-2 px-4 md:px-6 rounded-lg transition duration-200">
                                Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Productos -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto" style="max-height: calc(100vh - 400px);">
                        <table class="min-w-full divide-y divide-gemini-gray-200" style="min-width: 1400px;">
                        <thead class="bg-gemini-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">ID</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">SKU</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Nombre</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Tipo</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Proveedor</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Costo</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Valor Total</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Stock Actual</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Stock M칤nimo</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Fecha Compra</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Fecha Salida</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Tipo Stock</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Gramaje</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Peso Total</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Ajustar Stock</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body" class="bg-white divide-y divide-gemini-gray-200">
                            <!-- Los productos se cargar치n aqu칤 desde JS -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Vista: MRP -->
            <div id="view-mrp" class="view-content hidden">
                <h2 class="text-3xl font-semibold mb-6">Producci칩n y MRP</h2>
                
                <!-- Definici칩n de BOM (Lista de Materiales) -->
                <div class="bg-white p-8 rounded-lg shadow mb-8">
                    <h3 class="font-semibold mb-4 text-xl">Definir Lista de Materiales (BOM)</h3>
                    
                    <!-- 1. Seleccionar producto padre -->
                    <div class="mb-4">
                        <label for="mrp-select-parent" class="block text-sm font-medium text-gemini-gray-700">Selecciona un Producto (Cualquier producto puede ser padre)</label>
                        <select id="mrp-select-parent" class="mt-1 block w-full md:w-1/2 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <option value="">Cargando productos...</option>
                        </select>
                    </div>

                    <!-- 2. Formulario para a침adir insumos (hijos) -->
                    <form id="form-add-bom" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="mrp-select-child" class="block text-sm font-medium text-gemini-gray-700">Insumo / Producto Componente (Cualquier producto puede ser hijo)</label>
                            <select id="mrp-select-child" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <option value="">Cargando productos...</option>
                            </select>
                        </div>
                        <div>
                            <label for="mrp-child-quantity" class="block text-sm font-medium text-gemini-gray-700">Cantidad Necesaria</label>
                            <input type="number" id="mrp-child-quantity" value="1" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        </div>
                        <div>
                            <button type="submit" class="w-full bg-gemini-blue hover:bg-gemini-blue-dark text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                A침adir Insumo
                            </button>
                        </div>
                    </form>

                    <!-- 3. Lista de BOM actual -->
                    <div class="mt-6">
                        <h4 class="font-semibold mb-2">Insumos actuales para este producto:</h4>
                        <ul id="mrp-bom-list" class="list-disc list-inside bg-gemini-gray-100 p-4 rounded-lg">
                            <!-- Insumos se cargar치n aqu칤 -->
                        </ul>
                    </div>
                </div>

                <!-- Calculadora de MRP -->
                <div class="bg-white p-8 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-xl">Calculadora de Producci칩n (MRP)</h3>
                    <p class="mb-4">Una vez definas el BOM (arriba), aqu칤 podr치s calcular cu치ntos productos puedes fabricar con tu inventario actual.</p>
                    <div class="mt-4">
                        <label for="mrp-calculate-product" class="block text-sm font-medium text-gemini-gray-700 mb-2">Selecciona el producto a calcular:</label>
                        <select id="mrp-calculate-product" class="mt-1 block w-full md:w-1/2 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <option value="">Selecciona un producto...</option>
                        </select>
                        <button onclick="calculateMRP()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                            Calcular Producci칩n
                        </button>
                        <div id="mrp-result" class="mt-4 p-4 bg-gemini-gray-100 rounded-lg hidden">
                            <!-- Resultados del c치lculo MRP -->
                        </div>
                        <div id="mrp-production-controls" class="mt-4 hidden">
                            <label for="mrp-production-quantity" class="block text-sm font-medium text-gemini-gray-700 mb-2">Cantidad a Producir:</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="mrp-production-quantity" min="1" step="1" class="block w-32 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <button onclick="executeProduction()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                                    Ejecutar Producci칩n
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Esto reducir치 el stock de los insumos y aumentar치 el stock del producto final.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista: Finanzas -->
            <div id="view-finanzas" class="view-content hidden">
                <h2 class="text-3xl font-semibold mb-6">Gesti칩n de Finanzas</h2>

                <!-- Historial de Ventas -->
                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl text-blue-700">Historial de Ventas</h3>
                        <div class="flex space-x-2">
                            <div class="relative">
                                <button onclick="toggleSalesReportMenu()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                    Descargar Informe
                                </button>
                                <div id="salesReportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10 border">
                                    <div class="py-1">
                                        <button onclick="exportSalesReport('day')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Informe del D칤a</button>
                                        <button onclick="exportSalesReport('week')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Informe de la Semana</button>
                                        <button onclick="exportSalesReport('month')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Informe del Mes</button>
                                        <button onclick="exportSalesReport('year')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Informe del A침o</button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="showAddSaleModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Nueva Venta
                            </button>
                            <button onclick="showAddMultipleSalesModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                M칰ltiples Ventas
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gemini-gray-200">
                            <thead class="bg-gemini-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Producto</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Cantidad</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Precio Unitario</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-list-body" class="bg-white divide-y divide-gemini-gray-200">
                                <!-- Se rellena con JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Columna de Ingresos -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-xl text-green-700">A침adir Ingreso</h3>
                        <form id="form-add-revenue">
                            <div class="mb-4">
                                <label for="revenue-description" class="block text-sm font-medium text-gemini-gray-700">Descripci칩n</label>
                                <input type="text" id="revenue-description" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="revenue-amount" class="block text-sm font-medium text-gemini-gray-700">Monto</label>
                                <input type="number" id="revenue-amount" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="revenue-date" class="block text-sm font-medium text-gemini-gray-700">Fecha (DD-MM-YYYY)</label>
                                <input type="text" id="revenue-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500">Formato: DD-MM-YYYY (ej: 25-12-2024). Dejar vac칤o para fecha actual.</p>
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                                Guardar Ingreso
                            </button>
                        </form>
                        <hr class="my-6">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Ingresos</h4>
                            <button onclick="loadAllFinances()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Ver Todos</button>
                        </div>
                        <ul id="recent-revenue-list" class="divide-y divide-gemini-gray-200">
                            <!-- Se rellena con JS -->
                        </ul>
                    </div>

                    <!-- Columna de Costos -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-xl text-red-700">A침adir Costo / Gasto</h3>
                        <form id="form-add-cost">
                            <div class="mb-4">
                                <label for="cost-description" class="block text-sm font-medium text-gemini-gray-700">Descripci칩n</label>
                                <input type="text" id="cost-description" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="cost-amount" class="block text-sm font-medium text-gemini-gray-700">Monto</label>
                                <input type="number" id="cost-amount" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="cost-category" class="block text-sm font-medium text-gemini-gray-700">Categor칤a</label>
                                <select id="cost-category" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                    <option value="Materia Prima">Materia Prima</option>
                                    <option value="Log칤stica">Log칤stica</option>
                                    <option value="Sueldos">Sueldos</option>
                                    <option value="Servicios">Servicios</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="cost-date" class="block text-sm font-medium text-gemini-gray-700">Fecha (DD-MM-YYYY)</label>
                                <input type="text" id="cost-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500">Formato: DD-MM-YYYY (ej: 25-12-2024). Dejar vac칤o para fecha actual.</p>
                            </div>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                                Guardar Costo
                            </button>
                        </form>
                        <hr class="my-6">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Costos</h4>
                            <button onclick="loadAllFinances()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Ver Todos</button>
                        </div>
                        <ul id="recent-costs-list" class="divide-y divide-gemini-gray-200">
                            <!-- Se rellena con JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Modal para Nueva/Editar Venta -->
            <div id="addSaleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-semibold mb-4" id="sale-modal-title">Nueva Venta</h3>
                    <form id="form-add-sale">
                        <input type="hidden" id="sale-id" value="">
                        <div class="mb-4">
                            <label for="sale-product" class="block text-sm font-medium text-gemini-gray-700">Producto</label>
                            <select id="sale-product" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                                <option value="">Cargando productos...</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="sale-quantity" class="block text-sm font-medium text-gemini-gray-700">Cantidad</label>
                            <input type="number" id="sale-quantity" step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                        </div>
                        <div class="mb-4">
                            <label for="sale-unit-price" class="block text-sm font-medium text-gemini-gray-700">Precio Unitario</label>
                            <input type="number" id="sale-unit-price" step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                        </div>
                        <div class="mb-4">
                            <label for="sale-date" class="block text-sm font-medium text-gemini-gray-700">Fecha (DD-MM-YYYY)</label>
                            <input type="text" id="sale-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500">Dejar vac칤o para fecha actual.</p>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeAddSaleModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Guardar Venta
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal para Editar Producto -->
            <div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-semibold mb-4">Editar Producto</h3>
                    <form id="form-edit-product">
                        <input type="hidden" id="edit-product-id" value="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit-product-sku" class="block text-sm font-medium text-gemini-gray-700">SKU / ID</label>
                                <input type="text" id="edit-product-sku" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="C칩digo SKU">
                            </div>
                            <div class="md:col-span-1">
                                <label for="edit-product-name" class="block text-sm font-medium text-gemini-gray-700">Nombre *</label>
                                <input type="text" id="edit-product-name" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div>
                                <label for="edit-product-type" class="block text-sm font-medium text-gemini-gray-700">Tipo de Producto</label>
                                <select id="edit-product-type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                    <option value="hijo">Insumo / Hijo</option>
                                    <option value="final">Producto Final</option>
                                    <option value="padre">Sub-ensamblaje / Padre</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-product-supplier" class="block text-sm font-medium text-gemini-gray-700">Proveedor</label>
                                <input type="text" id="edit-product-supplier" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Nombre del proveedor">
                            </div>
                            <div>
                                <label for="edit-product-cost" class="block text-sm font-medium text-gemini-gray-700">Costo Unitario</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="edit-product-cost" value="0" step="0.01" class="mt-1 block flex-1 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                    <button type="button" onclick="calculateCostFromBOMEdit()" class="mt-1 text-xs bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Calcular costo basado en BOM">游눯</button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500">Costo final = Costo de materiales + Costo adicional</p>
                            </div>
                            <div>
                                <label for="edit-product-additional-cost" class="block text-sm font-medium text-gemini-gray-700">Costo Adicional</label>
                                <input type="number" id="edit-product-additional-cost" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500">Costos adicionales (mano de obra, overhead, etc.)</p>
                            </div>
                            <div>
                                <label for="edit-product-stock" class="block text-sm font-medium text-gemini-gray-700">Stock Actual</label>
                                <input type="number" id="edit-product-stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500" id="edit-stock-unit-hint">En unidades o gramos seg칰n el tipo seleccionado</p>
                            </div>
                            <div>
                                <label for="edit-product-min-stock" class="block text-sm font-medium text-gemini-gray-700">Stock M칤nimo</label>
                                <input type="number" id="edit-product-min-stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500" id="edit-min-stock-unit-hint">En unidades o gramos seg칰n el tipo seleccionado</p>
                            </div>
                            <div>
                                <label for="edit-product-stock-unit-type" class="block text-sm font-medium text-gemini-gray-700">Tipo de Medici칩n de Stock</label>
                                <select id="edit-product-stock-unit-type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" onchange="updateEditStockUnitHints()">
                                    <option value="units">Unidades</option>
                                    <option value="grams">Gramos</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">Unidades: cuenta por piezas. Gramos: cuenta por peso.</p>
                            </div>
                            <div>
                                <label for="edit-product-weight" class="block text-sm font-medium text-gemini-gray-700">Gramaje por Unidad (g)</label>
                                <input type="number" id="edit-product-weight" value="0" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Gramos por unidad">
                                <p class="mt-1 text-xs text-gray-500">Solo aplica si el stock se mide en unidades.</p>
                            </div>
                            <div>
                                <label for="edit-product-purchase-date" class="block text-sm font-medium text-gemini-gray-700">Fecha de Compra</label>
                                <input type="date" id="edit-product-purchase-date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            </div>
                            <div>
                                <label for="edit-product-exit-date" class="block text-sm font-medium text-gemini-gray-700">Fecha de Salida</label>
                                <input type="date" id="edit-product-exit-date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="closeEditProductModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal para M칰ltiples Ventas -->
            <div id="addMultipleSalesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-semibold mb-4">Agregar M칰ltiples Ventas</h3>
                    <div id="multiple-sales-container" class="space-y-4 mb-4">
                        <!-- Las filas de ventas se agregar치n aqu칤 din치micamente -->
                    </div>
                    <div class="flex justify-between mb-4">
                        <button onclick="addSaleRow()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            + Agregar Fila
                        </button>
                    </div>
                    <div class="mb-4">
                        <label for="multiple-sales-date" class="block text-sm font-medium text-gemini-gray-700">Fecha Com칰n (DD-MM-YYYY) - Opcional</label>
                        <input type="text" id="multiple-sales-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        <p class="mt-1 text-xs text-gray-500">Si se especifica, se aplicar치 a todas las ventas. Dejar vac칤o para fecha actual.</p>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeAddMultipleSalesModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Cancelar
                        </button>
                        <button onclick="saveMultipleSales()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Guardar Todas las Ventas
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Notificaci칩n Global -->
    <div id="notification" class="hidden fixed bottom-10 right-10 bg-gemini-gray-900 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0">
        <span id="notification-message"></span>
    </div>


    <!-- 4. JavaScript de la Aplicaci칩n -->
    <script>
        /* --- NAVEGACI칍N --- */
        
        let currentView = 'dashboard'; // Rastrear la vista actual
        
        function showView(viewId) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            // Quitar clase activa de todos los links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-gemini-blue-dark', 'font-medium', 'bg-gemini-blue-light');
            });
            
            // Mostrar la vista seleccionada
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            // Marcar link como activo
            const activeLink = document.querySelector(`.nav-link[onclick="showView('${viewId}')"]`);
            activeLink.classList.add('text-gemini-blue-dark', 'font-medium', 'bg-gemini-blue-light');

            currentView = viewId; // Actualizar vista actual
            reloadDataInCurrentView(); // Cargar datos
        }

        function reloadDataInCurrentView() {
            // Cargar datos espec칤ficos de la vista
            if (currentView === 'dashboard') {
                loadDashboardData();
            }
            if (currentView === 'inventory') {
                loadInventoryData();
            }
            if (currentView === 'mrp') {
                loadMrpData();
            }
            // Cargar datos de finanzas
            if (currentView === 'finanzas') {
                loadFinanzasData();
                loadSalesData();
            }
        }

        /* --- NOTIFICACI칍N --- */
        
        function showNotification(message) {
            const el = document.getElementById('notification');
            document.getElementById('notification-message').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('opacity-100'), 10); // Fade in
            setTimeout(() => {
                el.classList.remove('opacity-100');
                setTimeout(() => el.classList.add('hidden'), 500); // Fade out
            }, 3000);
        }

        /* --- L칍GICA DE INVENTARIO --- */
        
        let editingProductId = null;
        
        function updateStockUnitHints() {
            const stockUnitType = document.getElementById('product_stock_unit_type').value;
            const stockHint = document.getElementById('stock-unit-hint');
            const minStockHint = document.getElementById('min-stock-unit-hint');
            
            if (stockHint) {
                stockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 10 bolsas)' : 'En gramos (ej: 1000 g)';
            }
            if (minStockHint) {
                minStockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 5 bolsas)' : 'En gramos (ej: 500 g)';
            }
        }
        
        // Inicializar hints al cargar
        document.addEventListener('DOMContentLoaded', function() {
            const stockUnitTypeSelect = document.getElementById('product_stock_unit_type');
            if (stockUnitTypeSelect) {
                stockUnitTypeSelect.addEventListener('change', updateStockUnitHints);
                updateStockUnitHints(); // Inicializar
            }
        });

        document.getElementById('form-add-product').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Si estamos editando, usar la funci칩n de actualizaci칩n
            if (editingProductId !== null) {
                const name = document.getElementById('product_name').value;
                const type = document.getElementById('product_type').value;
                const cost = document.getElementById('product_cost').value;
                const stock = document.getElementById('product_stock').value;
                const min_stock = document.getElementById('product_min_stock').value;
                const supplier = document.getElementById('product_supplier').value || null;
                const purchase_date = document.getElementById('product_purchase_date').value || null;
                const exit_date = document.getElementById('product_exit_date').value || null;
                const sku = document.getElementById('product_sku').value || null;
                const weight = document.getElementById('product_weight').value || 0;
                const stock_unit_type = document.getElementById('product_stock_unit_type').value || 'units';
                const additional_cost = document.getElementById('product_additional_cost').value || 0;

                const result = await window.pywebview.api.update_product(editingProductId, name, type, stock, min_stock, cost, supplier, purchase_date, exit_date, sku, weight, stock_unit_type, additional_cost);
                showNotification(result.message);
                
                if (result.success) {
                    loadInventoryData();
                    e.target.reset();
                    editingProductId = null;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Guardar Producto';
                }
                return;
            }

            // Si no, agregar nuevo producto
            const name = document.getElementById('product_name').value;
            const type = document.getElementById('product_type').value;
            const cost = document.getElementById('product_cost').value;
            const stock = document.getElementById('product_stock').value;
            const min_stock = document.getElementById('product_min_stock').value;
            const supplier = document.getElementById('product_supplier').value || null;
            const purchase_date = document.getElementById('product_purchase_date').value || null;
            const exit_date = document.getElementById('product_exit_date').value || null;
            const sku = document.getElementById('product_sku').value || null;
            const weight = document.getElementById('product_weight').value || 0;
            const stock_unit_type = document.getElementById('product_stock_unit_type').value || 'units';
            const additional_cost = document.getElementById('product_additional_cost').value || 0;

            // Llamada a la API de Python
            const result = await window.pywebview.api.add_product(name, type, stock, min_stock, cost, supplier, purchase_date, exit_date, sku, weight, stock_unit_type, additional_cost);
            
            if (result.success) {
                showNotification(result.message);
                loadInventoryData(); // Recargar la lista
                e.target.reset(); // Limpiar formulario
            } else {
                showNotification(`Error: ${result.message}`);
            }
        });

        async function loadInventoryData() {
            // Llamada a la API de Python
            const result = await window.pywebview.api.load_products();
            
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            const products = result.data;

            const tbody = document.getElementById('product-list-body');
            tbody.innerHTML = ''; // Limpiar lista
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="16" class="px-6 py-4 text-center text-gemini-gray-700">No hay productos en el inventario.</td></tr>';
                return;
            }

            let totalStock = 0;
            let stockAlerts = 0;
            let totalValue = 0;

            products.forEach(p => {
                // Alerta de stock bajo
                let stockClass = 'text-gemini-gray-900';
                if (p.stock < p.min_stock) {
                    stockClass = 'text-red-600 font-bold';
                    stockAlerts++;
                }
                totalStock += p.stock;
                totalValue += p.stock * (p.cost || 0);

                // Formatear fechas
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('es-ES');
                };

                tbody.innerHTML += `
                    <tr>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.id}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.sku || '-'}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.name}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.product_type}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.supplier || '-'}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-1">
                                <span id="cost-display-${p.id}" class="text-sm">$ ${(p.cost || 0).toFixed(2)}</span>
                                <button onclick="editProductCost(${p.id})" class="text-xs bg-blue-500 text-white px-1 py-0.5 rounded hover:bg-blue-600" title="Editar costo">九勇</button>
                            </div>
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap font-semibold text-green-700 text-sm">
                            $ ${((p.stock || 0) * (p.cost || 0)).toFixed(2)}
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap ${stockClass} text-sm">
                            ${p.stock} ${p.stock_unit_type === 'units' ? 'unid.' : 'g'}
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">
                            ${p.min_stock} ${p.stock_unit_type === 'units' ? 'unid.' : 'g'}
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">${formatDate(p.purchase_date)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">${formatDate(p.exit_date)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${p.stock_unit_type === 'units' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                ${p.stock_unit_type === 'units' ? 'Unid.' : 'Gramos'}
                            </span>
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">${(p.weight || 0).toFixed(2)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap font-semibold text-gemini-blue-dark text-sm">${(p.total_weight || 0).toFixed(2)} g</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <form class="flex items-center space-x-1" onsubmit="adjustStock(event, ${p.id})">
                                <input id="adjust-stock-input-${p.id}" type="number" step="0.01" placeholder="${p.stock_unit_type === 'units' ? '췀' : '췀'}" class="w-16 md:w-20 block rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue text-xs">
                                <button type="submit" class="text-xs bg-gemini-blue text-white px-1.5 py-0.5 rounded-md hover:bg-gemini-blue-dark whitespace-nowrap">Ajustar</button>
                            </form>
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <div class="flex flex-col space-y-1">
                                <button onclick="showEditProductModal(${p.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-md hover:bg-yellow-600 whitespace-nowrap" title="Editar producto completo">九勇</button>
                                <button onclick="deleteProduct(${p.id}, '${p.name.replace(/'/g, "\\'")}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 whitespace-nowrap" title="Eliminar producto">游딈勇</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            // Actualizar KPIs del dashboard (si los elementos existen)
            const kpiStock = document.getElementById('kpi-total-stock');
            const kpiValue = document.getElementById('kpi-inventory-value');

            if (kpiStock) kpiStock.textContent = totalStock;
            if (kpiValue) kpiValue.textContent = `$ ${totalValue.toFixed(2)}`;
            
            // Actualizar lista de productos con alerta
            updateStockAlertsList(products);
        }
        
        function updateStockAlertsList(products) {
            const alertsList = document.getElementById('stock-alerts-list');
            if (!alertsList) return;
            
            const productsWithAlerts = products.filter(p => p.stock < p.min_stock);
            
            if (productsWithAlerts.length === 0) {
                alertsList.innerHTML = '<p class="text-green-600 font-medium">九 No hay productos con alerta de stock bajo.</p>';
                return;
            }
            
            alertsList.innerHTML = '';
            productsWithAlerts.forEach(p => {
                const stockPercent = p.min_stock > 0 ? ((p.stock / p.min_stock) * 100).toFixed(1) : 0;
                const unitLabel = p.stock_unit_type === 'units' ? 'unidades' : 'g';
                alertsList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200 hover:bg-red-100 transition-colors">
                        <div class="flex-1">
                            <div class="font-semibold text-red-800">${p.name}${p.sku ? ` [${p.sku}]` : ''}</div>
                            <div class="text-sm text-gray-600">
                                Stock actual: <span class="font-bold text-red-600">${p.stock} ${unitLabel}</span> | 
                                Stock m칤nimo: <span class="font-medium">${p.min_stock} ${unitLabel}</span>
                                ${p.min_stock > 0 ? `(${stockPercent}% del m칤nimo)` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-red-700 font-medium">Faltan ${(p.min_stock - p.stock).toFixed(2)} ${unitLabel}</div>
                            <button onclick="showEditProductModal(${p.id})" class="mt-1 text-xs bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600">
                                Editar
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // Funci칩n para ajustar stock
        async function adjustStock(event, productId) {
            event.preventDefault();
            const inputEl = document.getElementById(`adjust-stock-input-${productId}`);
            const quantityChange = inputEl.value;

            if (!quantityChange || quantityChange == 0) {
                showNotification("Por favor, introduce una cantidad para ajustar.");
                return;
            }

            const result = await window.pywebview.api.adjust_inventory(productId, quantityChange);
            showNotification(result.message);
            
            if (result.success) {
                loadInventoryData(); // Recargar la lista de inventario
            }
        }

        // Funci칩n para editar producto (versi칩n antigua - mantener para compatibilidad)
        async function editProduct(productId) {
            showEditProductModal(productId);
        }
        
        // Funci칩n para mostrar modal de edici칩n de producto
        async function showEditProductModal(productId) {
            const result = await window.pywebview.api.load_products();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const product = result.data.find(p => p.id === productId);
            if (!product) {
                showNotification("Producto no encontrado");
                return;
            }

            // Llenar el formulario del modal con los datos del producto
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-sku').value = product.sku || '';
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-type').value = product.product_type;
            document.getElementById('edit-product-supplier').value = product.supplier || '';
            document.getElementById('edit-product-cost').value = product.cost || 0;
            document.getElementById('edit-product-stock').value = product.stock || 0;
            document.getElementById('edit-product-min-stock').value = product.min_stock || 0;
            document.getElementById('edit-product-purchase-date').value = product.purchase_date || '';
            document.getElementById('edit-product-exit-date').value = product.exit_date || '';
            document.getElementById('edit-product-weight').value = product.weight || 0;
            document.getElementById('edit-product-stock-unit-type').value = product.stock_unit_type || 'units';
            document.getElementById('edit-product-additional-cost').value = product.additional_cost || 0;
            
            // Actualizar hints
            updateEditStockUnitHints();

            // Mostrar el modal
            document.getElementById('editProductModal').classList.remove('hidden');
        }
        
        function closeEditProductModal() {
            document.getElementById('editProductModal').classList.add('hidden');
            document.getElementById('form-edit-product').reset();
        }
        
        function updateEditStockUnitHints() {
            const stockUnitType = document.getElementById('edit-product-stock-unit-type').value;
            const stockHint = document.getElementById('edit-stock-unit-hint');
            const minStockHint = document.getElementById('edit-min-stock-unit-hint');
            
            if (stockHint) {
                stockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 10 bolsas)' : 'En gramos (ej: 1000 g)';
            }
            if (minStockHint) {
                minStockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 5 bolsas)' : 'En gramos (ej: 500 g)';
            }
        }
        
        // Funci칩n para calcular costo desde BOM (formulario principal)
        async function calculateCostFromBOM() {
            // Necesitamos el ID del producto, pero en el formulario de agregar no lo tenemos a칰n
            // Solo podemos calcular si estamos editando
            if (editingProductId === null) {
                showNotification('Primero guarda el producto y define su BOM, luego podr치s calcular el costo autom치ticamente.');
                return;
            }
            
            const result = await window.pywebview.api.calculate_bom_cost(editingProductId);
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const data = result.data;
            if (data.components.length === 0) {
                showNotification('Este producto no tiene componentes en el BOM. Agrega componentes primero.');
                return;
            }
            
            // Actualizar el costo calculado
            document.getElementById('product_cost').value = data.calculated_cost.toFixed(2);
            document.getElementById('product_additional_cost').value = data.additional_cost.toFixed(2);
            
            // Mostrar desglose
            let breakdown = `Costo calculado: $${data.calculated_cost.toFixed(2)}\n`;
            breakdown += `Materiales: $${data.materials_cost.toFixed(2)}\n`;
            breakdown += `Adicional: $${data.additional_cost.toFixed(2)}\n\n`;
            breakdown += 'Desglose por componente:\n';
            data.components.forEach(comp => {
                breakdown += `- ${comp.component_name}: $${comp.total_cost.toFixed(2)} (${comp.required_quantity} ${comp.unit_type})\n`;
            });
            
            showNotification(breakdown);
        }
        
        // Funci칩n para calcular costo desde BOM (modal de edici칩n)
        async function calculateCostFromBOMEdit() {
            const productId = document.getElementById('edit-product-id').value;
            if (!productId) {
                showNotification('Error: No se encontr칩 el ID del producto.');
                return;
            }
            
            const result = await window.pywebview.api.calculate_bom_cost(productId);
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const data = result.data;
            if (data.components.length === 0) {
                showNotification('Este producto no tiene componentes en el BOM. Agrega componentes primero.');
                return;
            }
            
            // Actualizar el costo calculado
            document.getElementById('edit-product-cost').value = data.calculated_cost.toFixed(2);
            document.getElementById('edit-product-additional-cost').value = data.additional_cost.toFixed(2);
            
            // Mostrar desglose
            let breakdown = `Costo calculado: $${data.calculated_cost.toFixed(2)}\n`;
            breakdown += `Materiales: $${data.materials_cost.toFixed(2)}\n`;
            breakdown += `Adicional: $${data.additional_cost.toFixed(2)}\n\n`;
            breakdown += 'Desglose por componente:\n';
            data.components.forEach(comp => {
                breakdown += `- ${comp.component_name}: $${comp.total_cost.toFixed(2)} (${comp.required_quantity} ${comp.unit_type})\n`;
            });
            
            showNotification(breakdown);
        }
        
        // Event listener para el formulario de edici칩n
        document.getElementById('form-edit-product').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('edit-product-id').value;
            const name = document.getElementById('edit-product-name').value;
            const type = document.getElementById('edit-product-type').value;
            const cost = document.getElementById('edit-product-cost').value;
            const stock = document.getElementById('edit-product-stock').value;
            const min_stock = document.getElementById('edit-product-min-stock').value;
            const supplier = document.getElementById('edit-product-supplier').value || null;
            const purchase_date = document.getElementById('edit-product-purchase-date').value || null;
            const exit_date = document.getElementById('edit-product-exit-date').value || null;
            const sku = document.getElementById('edit-product-sku').value || null;
            const weight = document.getElementById('edit-product-weight').value || 0;
            const stock_unit_type = document.getElementById('edit-product-stock-unit-type').value || 'units';
            const additional_cost = document.getElementById('edit-product-additional-cost').value || 0;

            const result = await window.pywebview.api.update_product(productId, name, type, stock, min_stock, cost, supplier, purchase_date, exit_date, sku, weight, stock_unit_type, additional_cost);
            showNotification(result.message);
            
            if (result.success) {
                loadInventoryData();
                closeEditProductModal();
            }
        });

        // Funci칩n para eliminar producto
        async function deleteProduct(productId, productName) {
            if (!confirm(`쮼st치s seguro de que deseas eliminar el producto "${productName}"?`)) {
                return;
            }

            const result = await window.pywebview.api.delete_product(productId);
            showNotification(result.message);
            
            if (result.success) {
                loadInventoryData();
            }
        }

        // Funci칩n para editar costo unitario r치pidamente
        async function editProductCost(productId) {
            const result = await window.pywebview.api.load_products();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const product = result.data.find(p => p.id === productId);
            if (!product) {
                showNotification("Producto no encontrado");
                return;
            }

            const newCost = prompt(`Editar costo unitario de "${product.name}":`, product.cost || 0);
            if (newCost === null) return; // Usuario cancel칩

            const costValue = parseFloat(newCost);
            if (isNaN(costValue) || costValue < 0) {
                showNotification("Por favor, ingresa un valor num칠rico v치lido mayor o igual a 0");
                return;
            }

            // Actualizar solo el costo usando update_product
            const updateResult = await window.pywebview.api.update_product(
                productId, 
                product.name, 
                product.product_type, 
                product.stock, 
                product.min_stock, 
                costValue,
                product.supplier,
                product.purchase_date,
                product.exit_date,
                product.sku,
                product.weight || 0,
                product.stock_unit_type || 'units'
            );
            
            showNotification(updateResult.message);
            
            if (updateResult.success) {
                loadInventoryData(); // Recargar la lista
            }
        }

        /* --- L칍GICA DEL DASHBOARD --- */
        
        let kpiChartInstance = null;
        let topSalesChartInstance = null;
        let costBreakdownChartInstance = null;
        let inventoryValuationChartInstance = null;
        let currentPeriod = 'month';
        
        async function loadDashboardData(period = 'month') {
            currentPeriod = period;

            // Cargar datos financieros b치sicos
            const result = await window.pywebview.api.get_kpi_data(period);
            if (!result.success) {
                showNotification(`Error cargando KPIs: ${result.message}`);
                return;
            }
            
            const data = result.data;

            // 1. Actualizar KPIs de inventario
            const kpis = data.inventory_kpis;
            const kpiStock = document.getElementById('kpi-total-stock');
            const kpiValue = document.getElementById('kpi-inventory-value');

            if (kpiStock) kpiStock.textContent = kpis.total_stock_items;
            if (kpiValue) kpiValue.textContent = `$ ${kpis.total_inventory_value.toFixed(2)}`;
            
            // Cargar productos para mostrar alertas
            const productsResult = await window.pywebview.api.load_products();
            if (productsResult.success) {
                updateStockAlertsList(productsResult.data);
            }

            // 2. Actualizar Gr치fico Financiero con Utilidades
            const financeData = data.financial_summary;
            const ctx = document.getElementById('kpiChart').getContext('2d');
            
            if (kpiChartInstance) {
                kpiChartInstance.destroy();
            }
            
            kpiChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: financeData.labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: financeData.revenue,
                            borderColor: '#4285f4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Costos',
                            data: financeData.costs,
                            borderColor: '#ea4335',
                            backgroundColor: 'rgba(234, 67, 53, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Utilidades',
                            data: financeData.profit || [],
                            borderColor: '#34a853',
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 3. Cargar datos de BI
            await loadBIDashboardData();
        }

        async function loadBIDashboardData() {
            const result = await window.pywebview.api.get_bi_dashboard_data();
            if (!result.success) {
                console.error('Error cargando datos de BI:', result.message);
                return;
            }

            const biData = result.data;

            // Actualizar m칠tricas financieras
            const metrics = biData.financial_metrics;
            const profitMarginEl = document.getElementById('kpi-profit-margin');
            const avgTicketEl = document.getElementById('kpi-avg-ticket');
            const salesCountEl = document.getElementById('kpi-sales-count');
            const monthProfitEl = document.getElementById('kpi-month-profit');

            if (profitMarginEl) profitMarginEl.textContent = `${metrics.profit_margin}%`;
            if (avgTicketEl) avgTicketEl.textContent = `$ ${metrics.avg_ticket.toFixed(2)}`;
            if (salesCountEl) salesCountEl.textContent = metrics.sales_count;
            if (monthProfitEl) monthProfitEl.textContent = `$ ${metrics.profit.toFixed(2)}`;

            // Top 5 Productos M치s Vendidos (Gr치fico de Barras Horizontal)
            const topSalesCtx = document.getElementById('topSalesChart').getContext('2d');
            if (topSalesChartInstance) {
                topSalesChartInstance.destroy();
            }
            
            const topSales = biData.top_sales;
            topSalesChartInstance = new Chart(topSalesCtx, {
                type: 'bar',
                data: {
                    labels: topSales.map(p => p.product_name),
                    datasets: [{
                        label: 'Cantidad Vendida',
                        data: topSales.map(p => p.total_quantity),
                        backgroundColor: '#4285f4'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Top 5 Productos M치s Rentables (Lista)
            const topProfitList = document.getElementById('topProfitabilityList');
            topProfitList.innerHTML = '';
            biData.top_profitability.forEach((p, index) => {
                topProfitList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gemini-gray-100 rounded-lg">
                        <div>
                            <div class="font-semibold">${index + 1}. ${p.product_name}</div>
                            <div class="text-sm text-gray-600">Utilidad: $ ${(p.total_profit || 0).toFixed(2)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">$ ${(p.total_profit || 0).toFixed(2)}</div>
                            <div class="text-xs text-gray-500">${p.total_quantity} unidades</div>
                        </div>
                    </div>
                `;
            });

            // Desglose de Gastos por Categor칤a (Gr치fico de Dona)
            const costBreakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
            if (costBreakdownChartInstance) {
                costBreakdownChartInstance.destroy();
            }
            
            const costBreakdown = biData.cost_breakdown;
            const colors = ['#ea4335', '#fbbc04', '#34a853', '#4285f4', '#9aa0a6'];
            costBreakdownChartInstance = new Chart(costBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: costBreakdown.map(c => c.category),
                    datasets: [{
                        data: costBreakdown.map(c => c.total),
                        backgroundColor: colors.slice(0, costBreakdown.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Valorizaci칩n del Inventario por Categor칤a
            const inventoryValuationCtx = document.getElementById('inventoryValuationChart').getContext('2d');
            if (inventoryValuationChartInstance) {
                inventoryValuationChartInstance.destroy();
            }
            
            const inventoryValuation = biData.inventory_valuation;
            inventoryValuationChartInstance = new Chart(inventoryValuationCtx, {
                type: 'bar',
                data: {
                    labels: inventoryValuation.map(v => v.product_type),
                    datasets: [{
                        label: 'Valor Total',
                        data: inventoryValuation.map(v => v.total_value || 0),
                        backgroundColor: '#4285f4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Productos Sin Movimiento
            const productsNoMovementList = document.getElementById('productsNoMovementList');
            productsNoMovementList.innerHTML = '';
            if (biData.products_no_movement.length === 0) {
                productsNoMovementList.innerHTML = '<p class="text-gray-500">No hay productos sin movimiento.</p>';
            } else {
                biData.products_no_movement.forEach(p => {
                    productsNoMovementList.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div>
                                <div class="font-semibold">${p.name}</div>
                                <div class="text-sm text-gray-600">Stock: ${p.stock} | Valor: $ ${(p.total_value || 0).toFixed(2)}</div>
                            </div>
                            <div class="text-xs text-yellow-700">Sin movimiento</div>
                        </div>
                    `;
                });
            }
        }
        
        // Listener para el selector de per칤odo (se inicializa cuando el DOM est치 listo)
        function initPeriodSelector() {
            const periodSelector = document.getElementById('period-selector');
            if (periodSelector) {
                periodSelector.addEventListener('change', function() {
                    loadDashboardData(this.value);
                });
            }
        }

        /* --- L칍GICA DE MRP y BOM --- */

        async function loadMrpData() {
            // Cargar los <select> de productos
            const parentSelect = document.getElementById('mrp-select-parent');
            const childSelect = document.getElementById('mrp-select-child');
            const calculateSelect = document.getElementById('mrp-calculate-product');

            // Cargar TODOS los productos para ambos selectores
            // Cualquier producto puede ser padre o hijo
            const allProductsResult = await window.pywebview.api.load_products();
            
            parentSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            childSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            if (calculateSelect) {
                calculateSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            }
            
            if (allProductsResult.success) {
                allProductsResult.data.forEach(p => {
                    const skuText = p.sku ? ` [${p.sku}]` : '';
                    const typeText = ` (${p.product_type})`;
                    const optionText = `${p.name}${skuText}${typeText}`;
                    parentSelect.innerHTML += `<option value="${p.id}">${optionText}</option>`;
                    childSelect.innerHTML += `<option value="${p.id}">${optionText}</option>`;
                    if (calculateSelect) {
                        calculateSelect.innerHTML += `<option value="${p.id}">${optionText}</option>`;
                    }
                });
            }
        }
        
        async function calculateMRP() {
            const productId = document.getElementById('mrp-calculate-product').value;
            if (!productId) {
                showNotification('Por favor, selecciona un producto para calcular.');
                return;
            }
            
            const result = await window.pywebview.api.calculate_mrp_production(productId);
            const resultDiv = document.getElementById('mrp-result');
            
            if (!result.success) {
                resultDiv.innerHTML = `<p class="text-red-600">Error: ${result.message}</p>`;
                resultDiv.classList.remove('hidden');
                return;
            }
            
            const data = result.data;
            let html = `<h4 class="font-semibold text-lg mb-2">Resultado del C치lculo MRP</h4>`;
            html += `<p class="mb-4 text-green-700 font-medium">${data.message}</p>`;
            
            if (data.components && data.components.length > 0) {
                html += `<div class="mt-4"><h5 class="font-semibold mb-2">Componentes Necesarios:</h5>`;
                html += `<table class="min-w-full divide-y divide-gray-200">`;
                html += `<thead class="bg-gray-50"><tr>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Componente</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Cantidad Requerida</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Stock Disponible</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Tipo</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Puede Producir</th>`;
                html += `</tr></thead><tbody>`;
                
                data.components.forEach(comp => {
                    const child_unit_type = comp.child_stock_unit_type || 'units';
                    const unit_label = child_unit_type === 'units' ? 'unidades' : 'g';
                    
                    // Calcular cu치ntos se pueden producir
                    let canProduce;
                    if (child_unit_type === 'units') {
                        canProduce = Math.floor(comp.child_stock / comp.required_quantity);
                    } else {
                        canProduce = comp.child_stock / comp.required_quantity;
                    }
                    
                    const isLimiting = data.limiting_component && data.limiting_component.bom_id === comp.bom_id;
                    const rowClass = isLimiting ? 'bg-yellow-50' : '';
                    html += `<tr class="${rowClass}">`;
                    html += `<td class="px-4 py-2">${comp.child_name}${comp.child_sku ? ` [${comp.child_sku}]` : ''}</td>`;
                    html += `<td class="px-4 py-2">${comp.required_quantity} ${unit_label}</td>`;
                    html += `<td class="px-4 py-2">${comp.child_stock} ${unit_label}</td>`;
                    html += `<td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded-full ${child_unit_type === 'units' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${child_unit_type === 'units' ? 'Unidades' : 'Gramos'}</span></td>`;
                    html += `<td class="px-4 py-2 font-semibold">${canProduce.toFixed(2)} ${isLimiting ? '丘멆잺 (Limitante)' : ''}</td>`;
                    html += `</tr>`;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += `<p class="text-gray-600">Stock actual disponible: ${data.can_produce || 0}</p>`;
            }
            
            resultDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Mostrar controles de producci칩n si se pueden producir unidades
            const productionControls = document.getElementById('mrp-production-controls');
            if (data.can_produce > 0) {
                document.getElementById('mrp-production-quantity').max = data.can_produce;
                document.getElementById('mrp-production-quantity').value = data.can_produce;
                productionControls.classList.remove('hidden');
            } else {
                productionControls.classList.add('hidden');
            }
        }
        
        async function executeProduction() {
            const productId = document.getElementById('mrp-calculate-product').value;
            const quantity = document.getElementById('mrp-production-quantity').value;
            
            if (!productId || !quantity || quantity <= 0) {
                showNotification('Por favor, selecciona un producto y especifica una cantidad v치lida.');
                return;
            }
            
            if (!confirm(`쮼st치s seguro de que deseas producir ${quantity} unidades? Esto reducir치 el stock de los insumos y aumentar치 el stock del producto final.`)) {
                return;
            }
            
            const result = await window.pywebview.api.execute_production(productId, quantity);
            showNotification(result.message);
            
            if (result.success) {
                // Recalcular MRP para actualizar los valores
                await calculateMRP();
                // Recargar inventario si estamos en esa vista
                if (currentView === 'inventory') {
                    loadInventoryData();
                }
            }
        }

        // Event listener para cuando se selecciona un producto padre
        document.getElementById('mrp-select-parent').addEventListener('change', async function() {
            const parentId = this.value;
            if (!parentId) {
                document.getElementById('mrp-bom-list').innerHTML = '';
                return;
            }
            // Cargar el BOM para este producto
            loadBomList(parentId);
        });

        async function loadBomList(parentId) {
            const bomResult = await window.pywebview.api.get_bom(parentId);
            const bomListEl = document.getElementById('mrp-bom-list');
            bomListEl.innerHTML = '';
            
            if (bomResult.success && bomResult.data.length > 0) {
                bomResult.data.forEach(item => {
                    bomListEl.innerHTML += `
                        <li class="flex justify-between items-center mb-1">
                            <span>${item.child_product_name} (x${item.quantity})</span>
                            <button onclick="deleteBomEntry(${item.bom_id})" class="text-red-500 hover:text-red-700 text-xs">Eliminar</button>
                        </li>
                    `;
                });
            } else {
                bomListEl.innerHTML = '<li>No hay insumos definidos para este producto.</li>';
            }
        }

        // Event listener para a침adir un insumo al BOM
        document.getElementById('form-add-bom').addEventListener('submit', async function(e) {
            e.preventDefault();
            const parentId = document.getElementById('mrp-select-parent').value;
            const childId = document.getElementById('mrp-select-child').value;
            const quantity = document.getElementById('mrp-child-quantity').value;

            if (!parentId || !childId) {
                showNotification('Error: Debes seleccionar un producto padre y un componente.');
                return;
            }
            
            // Prevenir que un producto sea su propio hijo
            if (parentId === childId) {
                showNotification('Error: Un producto no puede ser componente de s칤 mismo.');
                return;
            }

            const result = await window.pywebview.api.add_bom_entry(parentId, childId, quantity);
            showNotification(result.message);
            
            if (result.success) {
                loadBomList(parentId); // Recargar la lista de BOM
                // Resetear formulario de a침adir
                document.getElementById('mrp-select-child').value = '';
                document.getElementById('mrp-child-quantity').value = '1';
            }
        });

        async function deleteBomEntry(bomId) {
            const parentId = document.getElementById('mrp-select-parent').value;
            const result = await window.pywebview.api.delete_bom_entry(bomId);
            showNotification(result.message);
            if (result.success && parentId) {
                loadBomList(parentId); // Recargar la lista
            }
        }


        /* --- L칍GICA DE FINANZAS --- */

        let showingAllFinances = false;

        async function loadFinanzasData() {
            showingAllFinances = false;
            const result = await window.pywebview.api.get_recent_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            renderFinances(result.data);
        }

        async function loadAllFinances() {
            showingAllFinances = true;
            const result = await window.pywebview.api.get_all_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            renderFinances(result.data);
        }

        function renderFinances(data) {
            const { revenue, costs } = data;
            
            // Formatear fecha
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('es-ES');
            };
            
            // Rellenar lista de ingresos
            const revenueListEl = document.getElementById('recent-revenue-list');
            revenueListEl.innerHTML = '';
            if (revenue.length > 0) {
                revenue.forEach(item => {
                    revenueListEl.innerHTML += `
                        <li class="py-2 flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-medium">${item.description}</div>
                                <div class="text-xs text-gray-500">${formatDate(item.date)}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-green-700">$ ${item.amount.toFixed(2)}</span>
                                <button onclick="editRevenue(${item.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Editar</button>
                                <button onclick="deleteRevenue(${item.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Eliminar</button>
                            </div>
                        </li>
                    `;
                });
            } else {
                revenueListEl.innerHTML = '<li class="py-2 text-gray-500">No hay ingresos.</li>';
            }

            // Rellenar lista de costos
            const costsListEl = document.getElementById('recent-costs-list');
            costsListEl.innerHTML = '';
            if (costs.length > 0) {
                costs.forEach(item => {
                    costsListEl.innerHTML += `
                        <li class="py-2 flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-medium">${item.description}</div>
                                <div class="text-xs text-gray-500">${formatDate(item.date)} | ${item.category || 'Otros'}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-red-700">$ ${item.amount.toFixed(2)}</span>
                                <button onclick="editCost(${item.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Editar</button>
                                <button onclick="deleteCost(${item.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Eliminar</button>
                            </div>
                        </li>
                    `;
                });
            } else {
                costsListEl.innerHTML = '<li class="py-2 text-gray-500">No hay costos.</li>';
            }
        }

        async function editRevenue(revenueId) {
            const result = await window.pywebview.api.get_all_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const revenue = result.data.revenue.find(r => r.id === revenueId);
            if (!revenue) {
                showNotification("Ingreso no encontrado");
                return;
            }

            const description = prompt("Descripci칩n:", revenue.description);
            if (description === null) return;

            const amount = prompt("Monto:", revenue.amount);
            if (amount === null) return;

            const date = prompt("Fecha (YYYY-MM-DD, dejar vac칤o para mantener):", revenue.date ? revenue.date.split('T')[0] : '');
            const finalDate = date === '' ? null : date;

            const updateResult = await window.pywebview.api.update_revenue_entry(revenueId, description, amount, finalDate);
            showNotification(updateResult.message);
            
            if (updateResult.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        async function editCost(costId) {
            const result = await window.pywebview.api.get_all_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const cost = result.data.costs.find(c => c.id === costId);
            if (!cost) {
                showNotification("Costo no encontrado");
                return;
            }

            const description = prompt("Descripci칩n:", cost.description);
            if (description === null) return;

            const amount = prompt("Monto:", cost.amount);
            if (amount === null) return;

            const category = prompt("Categor칤a (Materia Prima, Log칤stica, Sueldos, Servicios, Otros):", cost.category || 'Otros');
            if (category === null) return;

            const date = prompt("Fecha (YYYY-MM-DD, dejar vac칤o para mantener):", cost.date ? cost.date.split('T')[0] : '');
            const finalDate = date === '' ? null : date;

            const updateResult = await window.pywebview.api.update_cost_entry(costId, description, amount, finalDate, category);
            showNotification(updateResult.message);
            
            if (updateResult.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        async function deleteRevenue(revenueId) {
            if (!confirm("쮼st치s seguro de que deseas eliminar este ingreso?")) {
                return;
            }

            const result = await window.pywebview.api.delete_revenue_entry(revenueId);
            showNotification(result.message);
            
            if (result.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        async function deleteCost(costId) {
            if (!confirm("쮼st치s seguro de que deseas eliminar este costo?")) {
                return;
            }

            const result = await window.pywebview.api.delete_cost_entry(costId);
            showNotification(result.message);
            
            if (result.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        // Funci칩n para convertir DD-MM-YYYY a YYYY-MM-DD
        function convertDateFormat(dateStr) {
            if (!dateStr || dateStr.trim() === '') return null;
            const parts = dateStr.split('-');
            if (parts.length === 3 && parts[0].length === 2 && parts[1].length === 2 && parts[2].length === 4) {
                // Formato DD-MM-YYYY
                return `${parts[2]}-${parts[1]}-${parts[0]}`; // Convertir a YYYY-MM-DD
            }
            return null;
        }

        // Listener para formulario de Ingresos
        document.getElementById('form-add-revenue').addEventListener('submit', async function(e) {
            e.preventDefault();
            const description = document.getElementById('revenue-description').value;
            const amount = document.getElementById('revenue-amount').value;
            const dateInput = document.getElementById('revenue-date').value;
            const date = convertDateFormat(dateInput);
            
            const result = await window.pywebview.api.add_revenue_entry(description, amount, date);
            showNotification(result.message);
            
            if (result.success) {
                loadFinanzasData(); // Recargar listas
                e.target.reset(); // Limpiar formulario
            }
        });

        // Listener para formulario de Costos
        document.getElementById('form-add-cost').addEventListener('submit', async function(e) {
            e.preventDefault();
            const description = document.getElementById('cost-description').value;
            const amount = document.getElementById('cost-amount').value;
            const category = document.getElementById('cost-category').value;
            const dateInput = document.getElementById('cost-date').value;
            const date = convertDateFormat(dateInput);
            
            const result = await window.pywebview.api.add_cost_entry(description, amount, date, category);
            showNotification(result.message);
            
            if (result.success) {
                loadFinanzasData(); // Recargar listas
                e.target.reset(); // Limpiar formulario
            }
        });


        /* --- L칍GICA DE VENTAS --- */
        
        let saleRowCounter = 0;
        
        function addSaleRow() {
            saleRowCounter++;
            const container = document.getElementById('multiple-sales-container');
            const row = document.createElement('div');
            row.className = 'border rounded-lg p-4 bg-gray-50 relative';
            row.id = `sale-row-${saleRowCounter}`;
            row.innerHTML = `
                <button onclick="removeSaleRow(${saleRowCounter})" class="absolute top-2 right-2 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-full p-1.5 transition-colors" title="Eliminar esta fila">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pr-8">
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Producto</label>
                        <select class="sale-row-product block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Cantidad</label>
                        <input type="number" class="sale-row-quantity block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Precio Unitario</label>
                        <input type="number" class="sale-row-price block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Total</label>
                        <input type="text" class="sale-row-total block w-full rounded-md border-gemini-gray-300 shadow-sm bg-gray-100" readonly>
                    </div>
                </div>
            `;
            container.appendChild(row);
            
            // Cargar productos en el select
            loadProductsForMultipleSales(row.querySelector('.sale-row-product'));
            
            // Agregar listeners para calcular total
            const quantityInput = row.querySelector('.sale-row-quantity');
            const priceInput = row.querySelector('.sale-row-price');
            const totalInput = row.querySelector('.sale-row-total');
            
            function updateTotal() {
                const qty = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = `$ ${(qty * price).toFixed(2)}`;
            }
            
            quantityInput.addEventListener('input', updateTotal);
            priceInput.addEventListener('input', updateTotal);
        }
        
        function removeSaleRow(rowId) {
            const row = document.getElementById(`sale-row-${rowId}`);
            if (row) {
                // Confirmar si hay m치s de una fila
                const container = document.getElementById('multiple-sales-container');
                if (container.children.length > 1) {
                    row.remove();
                } else {
                    showNotification('Debe haber al menos una fila. Si quieres eliminar todo, cancela y vuelve a abrir el modal.');
                }
            }
        }
        
        async function loadProductsForMultipleSales(selectElement) {
            const result = await window.pywebview.api.load_products();
            if (result.success) {
                result.data.forEach(p => {
                    const skuText = p.sku ? ` [${p.sku}]` : '';
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name}${skuText} (${p.product_type})`;
                    option.setAttribute('data-name', p.name);
                    selectElement.appendChild(option);
                });
            }
        }
        
        function showAddMultipleSalesModal() {
            document.getElementById('addMultipleSalesModal').classList.remove('hidden');
            document.getElementById('multiple-sales-container').innerHTML = '';
            saleRowCounter = 0;
            addSaleRow(); // Agregar primera fila por defecto
        }
        
        function closeAddMultipleSalesModal() {
            document.getElementById('addMultipleSalesModal').classList.add('hidden');
            document.getElementById('multiple-sales-container').innerHTML = '';
            document.getElementById('multiple-sales-date').value = '';
        }
        
        async function saveMultipleSales() {
            const container = document.getElementById('multiple-sales-container');
            const rows = container.querySelectorAll('[id^="sale-row-"]');
            const commonDate = document.getElementById('multiple-sales-date').value;
            const date = convertDateFormat(commonDate);
            
            if (rows.length === 0) {
                showNotification('Por favor, agrega al menos una venta.');
                return;
            }
            
            const salesList = [];
            let hasError = false;
            
            for (const row of rows) {
                const productSelect = row.querySelector('.sale-row-product');
                const quantityInput = row.querySelector('.sale-row-quantity');
                const priceInput = row.querySelector('.sale-row-price');
                
                const productId = productSelect.value;
                const productOption = productSelect.options[productSelect.selectedIndex];
                const productName = productOption.getAttribute('data-name');
                const quantity = quantityInput.value;
                const unitPrice = priceInput.value;
                
                if (!productId || !quantity || !unitPrice) {
                    hasError = true;
                    continue;
                }
                
                salesList.push({
                    product_id: parseInt(productId),
                    product_name: productName,
                    quantity: parseFloat(quantity),
                    unit_price: parseFloat(unitPrice),
                    date: date
                });
            }
            
            if (hasError) {
                showNotification('Por favor, completa todos los campos de todas las filas.');
                return;
            }
            
            if (salesList.length === 0) {
                showNotification('No hay ventas v치lidas para guardar.');
                return;
            }
            
            const result = await window.pywebview.api.add_multiple_sales(salesList);
            showNotification(result.message);
            
            if (result.success) {
                closeAddMultipleSalesModal();
                loadSalesData();
                if (currentView === 'dashboard') {
                    loadDashboardData(currentPeriod);
                }
                if (currentView === 'finanzas') {
                    loadFinanzasData();
                }
            }
        }
        
        async function loadSalesData() {
            const result = await window.pywebview.api.get_all_sales();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const sales = result.data;
            const tbody = document.getElementById('sales-list-body');
            tbody.innerHTML = '';
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No hay ventas registradas.</td></tr>';
                return;
            }
            
            sales.forEach(s => {
                const date = s.date ? new Date(s.date).toLocaleDateString('es-ES') : '-';
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap">${date}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${s.product_name}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${s.quantity}</td>
                        <td class="px-4 py-3 whitespace-nowrap">$ ${s.unit_price.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-semibold">$ ${s.total_amount.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button onclick="editSale(${s.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 mr-1">Editar</button>
                            <button onclick="deleteSale(${s.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function deleteSale(saleId) {
            if (!confirm("쮼st치s seguro de que deseas eliminar esta venta?")) {
                return;
            }
            
            const result = await window.pywebview.api.delete_sale(saleId);
            showNotification(result.message);
            
            if (result.success) {
                loadSalesData();
                if (currentView === 'dashboard') {
                    loadDashboardData(currentPeriod);
                }
            }
        }

        let editingSaleId = null;

        function showAddSaleModal() {
            editingSaleId = null;
            document.getElementById('sale-modal-title').textContent = 'Nueva Venta';
            document.getElementById('sale-id').value = '';
            document.getElementById('addSaleModal').classList.remove('hidden');
            loadProductsForSale();
            document.getElementById('form-add-sale').reset();
        }

        async function editSale(saleId) {
            editingSaleId = saleId;
            const result = await window.pywebview.api.get_sale_by_id(saleId);
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const sale = result.data;
            document.getElementById('sale-modal-title').textContent = 'Editar Venta';
            document.getElementById('sale-id').value = sale.id;
            document.getElementById('sale-quantity').value = sale.quantity;
            document.getElementById('sale-unit-price').value = sale.unit_price;
            
            // Formatear fecha para el input
            if (sale.date) {
                const date = new Date(sale.date);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                document.getElementById('sale-date').value = `${day}-${month}-${year}`;
            }
            
            // Cargar productos y seleccionar el correcto
            await loadProductsForSale();
            document.getElementById('sale-product').value = sale.product_id;
            
            document.getElementById('addSaleModal').classList.remove('hidden');
        }

        function closeAddSaleModal() {
            document.getElementById('addSaleModal').classList.add('hidden');
            document.getElementById('form-add-sale').reset();
            editingSaleId = null;
        }

        async function loadProductsForSale() {
            // Cargar todos los productos para ventas (cualquier producto puede venderse)
            const result = await window.pywebview.api.load_products();
            const select = document.getElementById('sale-product');
            select.innerHTML = '<option value="">Selecciona un producto...</option>';
            
            if (result.success) {
                result.data.forEach(p => {
                    const skuText = p.sku ? ` [${p.sku}]` : '';
                    select.innerHTML += `<option value="${p.id}" data-name="${p.name}">${p.name}${skuText} (${p.product_type})</option>`;
                });
            }
        }

        document.getElementById('form-add-sale').addEventListener('submit', async function(e) {
            e.preventDefault();
            const saleId = document.getElementById('sale-id').value;
            const productId = document.getElementById('sale-product').value;
            const productOption = document.getElementById('sale-product').options[document.getElementById('sale-product').selectedIndex];
            const productName = productOption.getAttribute('data-name');
            const quantity = document.getElementById('sale-quantity').value;
            const unitPrice = document.getElementById('sale-unit-price').value;
            const dateInput = document.getElementById('sale-date').value;
            const date = convertDateFormat(dateInput);
            
            if (!productId || !quantity || !unitPrice) {
                showNotification("Por favor, completa todos los campos.");
                return;
            }
            
            let result;
            if (editingSaleId) {
                // Actualizar venta existente
                result = await window.pywebview.api.update_sale(editingSaleId, productId, productName, quantity, unitPrice, date);
            } else {
                // Crear nueva venta
                result = await window.pywebview.api.add_sale(productId, productName, quantity, unitPrice, date);
            }
            
            showNotification(result.message);
            
            if (result.success) {
                loadSalesData();
                closeAddSaleModal();
                if (currentView === 'dashboard') {
                    loadDashboardData(currentPeriod);
                }
                if (currentView === 'finanzas') {
                    loadFinanzasData();
                }
            }
        });

        /* --- L칍GICA DE EXPORTACI칍N A EXCEL --- */
        
        async function exportToExcel() {
            showNotification('Iniciando exportaci칩n a Excel...');
            window.pywebview.api.export_to_excel();
        }
        
        async function exportSalesReport(period) {
            showNotification(`Exportando informe de ventas (${period})...`);
            const result = await window.pywebview.api.export_sales_report(period);
            if (result.success) {
                // El archivo se guardar치 y se notificar치 desde Python
            }
            toggleSalesReportMenu(); // Cerrar men칰
        }
        
        function toggleSalesReportMenu() {
            const menu = document.getElementById('salesReportMenu');
            menu.classList.toggle('hidden');
        }
        
        // Cerrar men칰 al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('salesReportMenu');
            const button = event.target.closest('button[onclick="toggleSalesReportMenu()"]');
            if (menu && !button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
        
        async function openLastExcelFile() {
            const result = await window.pywebview.api.open_excel_file();
            if (result.success) {
                showNotification('Abriendo archivo Excel...');
            } else {
                showNotification(result.message || 'No se encontr칩 un archivo Excel reciente. Exporta primero un archivo.');
            }
        }

        /* --- INICIO --- */
        
        // Cargar la vista inicial (Dashboard) al iniciar
        window.addEventListener('pywebviewready', () => {
            initPeriodSelector(); // Inicializar selector de per칤odo
            showView('dashboard');
        });

    </script>
</body>
</html>