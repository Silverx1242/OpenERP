<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenERP</title>
    <!-- 1. Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Carga de Chart.js para los KPIs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 3. Tailwind Configuration (for Google/Gemini colors) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gemini-blue': {
                            light: '#e8f0fe',
                            DEFAULT: '#4285f4', // Google's main blue
                            dark: '#174ea6',
                        },
                        'gemini-gray': {
                            100: '#f8f9fa',
                            200: '#e9ecef',
                            300: '#dee2e6',
                            700: '#495057',
                            900: '#212529',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Clean font
                    }
                }
            }
        }
    </script>
    <style>
        /* Scrollbar style */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0b8c3; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gemini-gray-100 text-gemini-gray-900">

    <!-- Main application container -->
    <div class="flex h-screen">

        <!-- Side navigation bar -->
        <nav class="w-48 md:w-56 bg-white shadow-md flex flex-col flex-shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-xl font-bold text-gemini-blue-dark">OpenERP</h1>
            </div>
            <ul class="flex-grow p-2">
                <li class="mb-1">
                    <a href="#" onclick="showView('dashboard')" class="nav-link active flex items-center p-2 rounded-lg hover:bg-gemini-blue-light text-gemini-blue-dark font-medium">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                </li>
                <li class="mb-1">
                    <a href="#" onclick="showView('inventory')" class="nav-link flex items-center p-2 rounded-lg hover:bg-gemini-blue-light">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        Inventory
                    </a>
                </li>
                <li class="mb-1">
                    <a href="#" onclick="showView('mrp')" class="nav-link flex items-center p-2 rounded-lg hover:bg-gemini-blue-light">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 0l3 3m-3-3v10m-6 4h6m-6 0l-3-3m3 3V7m0 14A10 10 0 115.636 5.636 10 10 0 0112 3v18z"></path></svg>
                        Production & MRP
                    </a>
                </li>
                <!-- NEW! Finance Link -->
                <li class="mb-1">
                    <a href="#" onclick="showView('finanzas')" class="nav-link flex items-center p-2 rounded-lg hover:bg-gemini-blue-light">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2 1.343-2 3-2m0 8c1.11 0 2.08-.402 2.599-1M12 16v1m0-1v-8m0 0c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0 8c1.11 0 2.08.402 2.599 1M12 4V3m0 1v4m0 0c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0 8a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        Finance
                    </a>
                </li>
            </ul>
            <div class="p-4 border-t">
                <button onclick="exportToExcel()" class="w-full bg-gemini-blue hover:bg-gemini-blue-dark text-white font-bold py-2 px-4 rounded-lg transition duration-200 mb-2">
                    Export to Excel
                </button>
                <button onclick="openLastExcelFile()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    View Excel
                </button>
            </div>
        </nav>

        <!-- Main content -->
        <main class="flex-1 h-screen overflow-y-auto p-4 md:p-8">
            
            <!-- View: Dashboard -->
            <div id="view-dashboard" class="view-content">
                <h2 class="text-3xl font-semibold mb-6">Dashboard - Business Intelligence</h2>
                
                <!-- Quick Financial Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Profit Margin</div>
                        <div id="kpi-profit-margin" class="text-2xl font-bold text-green-600">0%</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Average Ticket</div>
                        <div id="kpi-avg-ticket" class="text-2xl font-bold text-gemini-blue-dark">$ 0.00</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Monthly Sales</div>
                        <div id="kpi-sales-count" class="text-2xl font-bold text-purple-600">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Monthly Profit</div>
                        <div id="kpi-month-profit" class="text-2xl font-bold text-green-600">$ 0.00</div>
                    </div>
                </div>

                <!-- KPIs de Inventario -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Total Inventory Value</div>
                        <div id="kpi-inventory-value" class="text-xl font-bold text-gemini-blue-dark">$ 0.00</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Stock Level (Total Items)</div>
                        <div id="kpi-total-stock" class="text-xl font-bold text-gemini-blue-dark">0</div>
                    </div>
                </div>

                <!-- Productos con Alerta de Stock -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="font-semibold mb-4 text-lg text-red-700">丘멆잺 Products with Low Stock Alert</h3>
                    <div id="stock-alerts-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

                <!-- Main Finance Chart -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">Revenue, Costs and Profits</h3>
                            <select id="period-selector" class="text-sm rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <option value="day">Daily</option>
                                <option value="week">Weekly</option>
                                <option value="month" selected>Monthly</option>
                                <option value="year">Yearly</option>
                            </select>
                        </div>
                    <canvas id="kpiChart" height="80"></canvas>
                    </div>

                <!-- Top Productos y Desglose de Gastos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Top 5 Best Selling Products -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Top 5 Best Selling Products</h3>
                        <canvas id="topSalesChart" height="200"></canvas>
                            </div>
                    
                    <!-- Top 5 Most Profitable Products -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Top 5 Most Profitable Products</h3>
                        <div id="topProfitabilityList" class="space-y-2">
                            <!-- Will be filled with JS -->
                            </div>
                            </div>
                        </div>

                <!-- Desglose de Gastos y Salud del Inventario -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Cost Breakdown by Category -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Cost Breakdown by Category</h3>
                        <canvas id="costBreakdownChart" height="200"></canvas>
                    </div>
                    
                    <!-- Inventory Valuation by Category -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-lg">Inventory Valuation by Category</h3>
                        <canvas id="inventoryValuationChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Productos Sin Movimiento -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="font-semibold mb-4 text-lg">Products Without Movement (Last 30 days)</h3>
                    <div id="productsNoMovementList" class="space-y-2">
                        <!-- Se llenar치 con JS -->
                    </div>
                </div>

            </div>

            <!-- View: Inventory -->
            <div id="view-inventory" class="view-content hidden">
                <h2 class="text-3xl font-semibold mb-6">Inventory Management</h2>
                
                <!-- Form to add product -->
                <div class="bg-white p-4 md:p-6 rounded-lg shadow mb-6 md:mb-8">
                    <h3 class="font-semibold mb-4 text-lg md:text-xl">Add New Product</h3>
                    <!-- MODIFIED! Grid with more fields -->
                    <form id="form-add-product" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                        <div>
                            <label for="product_sku" class="block text-sm font-medium text-gemini-gray-700">SKU / ID</label>
                            <input type="text" id="product_sku" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="SKU Code">
                        </div>
                        <div class="md:col-span-2">
                            <label for="product_name" class="block text-sm font-medium text-gemini-gray-700">Name</label>
                            <input type="text" id="product_name" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                        </div>
                        <div>
                            <label for="product_type" class="block text-sm font-medium text-gemini-gray-700">Product Type</label>
                            <select id="product_type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <option value="hijo">Component / Child</option>
                                <option value="final">Final Product</option>
                                <option value="padre">Sub-assembly / Parent</option>
                                <option value="otro">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="product_supplier" class="block text-sm font-medium text-gemini-gray-700">Supplier</label>
                            <input type="text" id="product_supplier" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Supplier name">
                        </div>
                        <div>
                            <label for="product_cost" class="block text-sm font-medium text-gemini-gray-700">Unit Cost</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="product_cost" value="0" step="0.01" class="mt-1 block flex-1 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <button type="button" onclick="calculateCostFromBOM()" class="mt-1 text-xs bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Calculate cost based on BOM">游눯 Calculate</button>
                            </div>
                            <p class="mt-1 text-xs text-gray-500" id="cost-calculation-hint">Final cost = Materials cost + Additional cost</p>
                        </div>
                        <div>
                            <label for="product_additional_cost" class="block text-sm font-medium text-gemini-gray-700">Additional Cost</label>
                            <input type="number" id="product_additional_cost" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500">Additional costs (labor, overhead, etc.) that are added to materials cost</p>
                        </div>
                        <div>
                            <label for="product_stock" class="block text-sm font-medium text-gemini-gray-700">Initial Stock</label>
                            <input type="number" id="product_stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500" id="stock-unit-hint">In units or grams according to selected type</p>
                        </div>
                        <div>
                            <label for="product_min_stock" class="block text-sm font-medium text-gemini-gray-700">Min Stock</label>
                            <input type="number" id="product_min_stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500" id="min-stock-unit-hint">In units or grams according to selected type</p>
                        </div>
                        <div>
                            <label for="product_purchase_date" class="block text-sm font-medium text-gemini-gray-700">Purchase Date</label>
                            <input type="date" id="product_purchase_date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        </div>
                        <div>
                            <label for="product_exit_date" class="block text-sm font-medium text-gemini-gray-700">Exit Date</label>
                            <input type="date" id="product_exit_date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        </div>
                        <div>
                            <label for="product_stock_unit_type" class="block text-sm font-medium text-gemini-gray-700">Stock Measurement Type</label>
                            <select id="product_stock_unit_type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" onchange="updateStockUnitHints()">
                                <option value="units">Units</option>
                                <option value="grams">Grams</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Units: count by pieces. Grams: count by weight.</p>
                        </div>
                        <div>
                            <label for="product_weight" class="block text-sm font-medium text-gemini-gray-700">Weight per Unit (g)</label>
                            <input type="number" id="product_weight" value="0" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Grams per unit">
                            <p class="mt-1 text-xs text-gray-500">Only applies if stock is measured in units.</p>
                        </div>
                        <div class="md:col-span-2 lg:col-span-4 flex justify-end">
                            <button type="submit" class="w-full md:w-auto bg-gemini-blue hover:bg-gemini-blue-dark text-white font-bold py-2 px-4 md:px-6 rounded-lg transition duration-200">
                                Save Product
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Productos -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto" style="max-height: calc(100vh - 400px);">
                        <table class="min-w-full divide-y divide-gemini-gray-200" style="min-width: 1400px;">
                        <thead class="bg-gemini-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">ID</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">SKU</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Name</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Type</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Supplier</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Cost</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Total Value</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Current Stock</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Min Stock</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Purchase Date</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Exit Date</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Stock Type</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Weight</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Total Weight</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Adjust Stock</th>
                                <th class="px-3 md:px-6 py-2 md:py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase whitespace-nowrap">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body" class="bg-white divide-y divide-gemini-gray-200">
                            <!-- Products will be loaded here from JS -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- View: MRP -->
            <div id="view-mrp" class="view-content hidden">
                <h2 class="text-3xl font-semibold mb-6">Production & MRP</h2>
                
                <!-- BOM Definition (Bill of Materials) -->
                <div class="bg-white p-8 rounded-lg shadow mb-8">
                    <h3 class="font-semibold mb-4 text-xl">Define Bill of Materials (BOM)</h3>
                    
                    <!-- 1. Select parent product -->
                    <div class="mb-4">
                        <label for="mrp-select-parent" class="block text-sm font-medium text-gemini-gray-700">Select a Product (Any product can be a parent)</label>
                        <select id="mrp-select-parent" class="mt-1 block w-full md:w-1/2 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <option value="">Loading products...</option>
                        </select>
                    </div>

                    <!-- 2. Form to add components (children) -->
                    <form id="form-add-bom" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="mrp-select-child" class="block text-sm font-medium text-gemini-gray-700">Component / Product (Any product can be a child)</label>
                            <select id="mrp-select-child" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <option value="">Loading products...</option>
                            </select>
                        </div>
                        <div>
                            <label for="mrp-child-quantity" class="block text-sm font-medium text-gemini-gray-700">Required Quantity</label>
                            <input type="number" id="mrp-child-quantity" value="1" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        </div>
                        <div>
                            <button type="submit" class="w-full bg-gemini-blue hover:bg-gemini-blue-dark text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Add Component
                            </button>
                        </div>
                    </form>

                    <!-- 3. Current BOM list -->
                    <div class="mt-6">
                        <h4 class="font-semibold mb-2">Current components for this product:</h4>
                        <ul id="mrp-bom-list" class="list-disc list-inside bg-gemini-gray-100 p-4 rounded-lg">
                            <!-- Components will be loaded here -->
                        </ul>
                    </div>
                </div>

                <!-- MRP Calculator -->
                <div class="bg-white p-8 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-xl">Production Calculator (MRP)</h3>
                    <p class="mb-4">Once you define the BOM (above), here you can calculate how many products you can manufacture with your current inventory.</p>
                    <div class="mt-4">
                        <label for="mrp-calculate-product" class="block text-sm font-medium text-gemini-gray-700 mb-2">Select product to calculate:</label>
                        <select id="mrp-calculate-product" class="mt-1 block w-full md:w-1/2 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <option value="">Select a product...</option>
                        </select>
                        <button onclick="calculateMRP()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                            Calculate Production
                        </button>
                        <div id="mrp-result" class="mt-4 p-4 bg-gemini-gray-100 rounded-lg hidden">
                            <!-- MRP calculation results -->
                        </div>
                        <div id="mrp-production-controls" class="mt-4 hidden">
                            <label for="mrp-production-quantity" class="block text-sm font-medium text-gemini-gray-700 mb-2">Quantity to Produce:</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="mrp-production-quantity" min="1" step="1" class="block w-32 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <button onclick="executeProduction()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                                    Execute Production
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">This will reduce component stock and increase final product stock.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Finance -->
            <div id="view-finanzas" class="view-content hidden">
                <h2 class="text-3xl font-semibold mb-6">Finance Management</h2>

                <!-- Sales History -->
                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl text-blue-700">Sales History</h3>
                        <div class="flex space-x-2">
                            <div class="relative">
                                <button onclick="toggleSalesReportMenu()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                    Download Report
                                </button>
                                <div id="salesReportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10 border">
                                    <div class="py-1">
                                        <button onclick="exportSalesReport('day')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Day Report</button>
                                        <button onclick="exportSalesReport('week')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Week Report</button>
                                        <button onclick="exportSalesReport('month')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Month Report</button>
                                        <button onclick="exportSalesReport('year')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Year Report</button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="showAddSaleModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                New Sale
                            </button>
                            <button onclick="showAddMultipleSalesModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Multiple Sales
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gemini-gray-200">
                            <thead class="bg-gemini-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Product</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Quantity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Unit Price</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gemini-gray-700 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-list-body" class="bg-white divide-y divide-gemini-gray-200">
                                <!-- Se rellena con JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Revenue Column -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-xl text-green-700">Add Revenue</h3>
                        <form id="form-add-revenue">
                            <div class="mb-4">
                                <label for="revenue-description" class="block text-sm font-medium text-gemini-gray-700">Description</label>
                                <input type="text" id="revenue-description" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="revenue-amount" class="block text-sm font-medium text-gemini-gray-700">Amount</label>
                                <input type="number" id="revenue-amount" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="revenue-date" class="block text-sm font-medium text-gemini-gray-700">Date (DD-MM-YYYY)</label>
                                <input type="text" id="revenue-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500">Formato: DD-MM-YYYY (ej: 25-12-2024). Dejar vac칤o para fecha actual.</p>
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                                Save Revenue
                            </button>
                        </form>
                        <hr class="my-6">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Revenue</h4>
                            <button onclick="loadAllFinances()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Ver Todos</button>
                        </div>
                        <ul id="recent-revenue-list" class="divide-y divide-gemini-gray-200">
                            <!-- Se rellena con JS -->
                        </ul>
                    </div>

                    <!-- Costs Column -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-xl text-red-700">Add Cost / Expense</h3>
                        <form id="form-add-cost">
                            <div class="mb-4">
                                <label for="cost-description" class="block text-sm font-medium text-gemini-gray-700">Description</label>
                                <input type="text" id="cost-description" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="cost-amount" class="block text-sm font-medium text-gemini-gray-700">Amount</label>
                                <input type="number" id="cost-amount" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div class="mb-4">
                                <label for="cost-category" class="block text-sm font-medium text-gemini-gray-700">Category</label>
                                <select id="cost-category" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                    <option value="Materia Prima">Materia Prima</option>
                                    <option value="Log칤stica">Log칤stica</option>
                                    <option value="Sueldos">Sueldos</option>
                                    <option value="Servicios">Servicios</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="cost-date" class="block text-sm font-medium text-gemini-gray-700">Date (DD-MM-YYYY)</label>
                                <input type="text" id="cost-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500">Formato: DD-MM-YYYY (ej: 25-12-2024). Dejar vac칤o para fecha actual.</p>
                            </div>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                                Save Cost
                            </button>
                        </form>
                        <hr class="my-6">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Costs</h4>
                            <button onclick="loadAllFinances()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Ver Todos</button>
                        </div>
                        <ul id="recent-costs-list" class="divide-y divide-gemini-gray-200">
                            <!-- Se rellena con JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Modal for New/Edit Sale -->
            <div id="addSaleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-semibold mb-4" id="sale-modal-title">New Sale</h3>
                    <form id="form-add-sale">
                        <input type="hidden" id="sale-id" value="">
                        <div class="mb-4">
                            <label for="sale-product" class="block text-sm font-medium text-gemini-gray-700">Producto</label>
                            <select id="sale-product" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                                <option value="">Loading products...</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="sale-quantity" class="block text-sm font-medium text-gemini-gray-700">Quantity</label>
                            <input type="number" id="sale-quantity" step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                        </div>
                        <div class="mb-4">
                            <label for="sale-unit-price" class="block text-sm font-medium text-gemini-gray-700">Unit Price</label>
                            <input type="number" id="sale-unit-price" step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                        </div>
                        <div class="mb-4">
                            <label for="sale-date" class="block text-sm font-medium text-gemini-gray-700">Date (DD-MM-YYYY)</label>
                            <input type="text" id="sale-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            <p class="mt-1 text-xs text-gray-500">Dejar vac칤o para fecha actual.</p>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeAddSaleModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Cancel
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Save Sale
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal for Edit Product -->
            <div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-semibold mb-4">Edit Product</h3>
                    <form id="form-edit-product">
                        <input type="hidden" id="edit-product-id" value="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit-product-sku" class="block text-sm font-medium text-gemini-gray-700">SKU / ID</label>
                                <input type="text" id="edit-product-sku" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="C칩digo SKU">
                            </div>
                            <div class="md:col-span-1">
                                <label for="edit-product-name" class="block text-sm font-medium text-gemini-gray-700">Nombre *</label>
                                <input type="text" id="edit-product-name" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            </div>
                            <div>
                                <label for="edit-product-type" class="block text-sm font-medium text-gemini-gray-700">Product Type</label>
                                <select id="edit-product-type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                    <option value="hijo">Component / Child</option>
                                    <option value="final">Final Product</option>
                                    <option value="padre">Sub-assembly / Parent</option>
                                    <option value="otro">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-product-supplier" class="block text-sm font-medium text-gemini-gray-700">Supplier</label>
                                <input type="text" id="edit-product-supplier" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Supplier name">
                            </div>
                            <div>
                                <label for="edit-product-cost" class="block text-sm font-medium text-gemini-gray-700">Unit Cost</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="edit-product-cost" value="0" step="0.01" class="mt-1 block flex-1 rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                    <button type="button" onclick="calculateCostFromBOMEdit()" class="mt-1 text-xs bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700" title="Calculate cost based on BOM">游눯</button>
                                </div>
                                <p class="mt-1 text-xs text-gray-500">Final cost = Materials cost + Additional cost</p>
                            </div>
                            <div>
                                <label for="edit-product-additional-cost" class="block text-sm font-medium text-gemini-gray-700">Additional Cost</label>
                                <input type="number" id="edit-product-additional-cost" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500">Additional costs (labor, overhead, etc.)</p>
                            </div>
                            <div>
                                <label for="edit-product-stock" class="block text-sm font-medium text-gemini-gray-700">Current Stock</label>
                                <input type="number" id="edit-product-stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500" id="edit-stock-unit-hint">In units or grams according to selected type</p>
                            </div>
                            <div>
                                <label for="edit-product-min-stock" class="block text-sm font-medium text-gemini-gray-700">Min Stock</label>
                                <input type="number" id="edit-product-min-stock" value="0" step="0.01" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                                <p class="mt-1 text-xs text-gray-500" id="edit-min-stock-unit-hint">In units or grams according to selected type</p>
                            </div>
                            <div>
                                <label for="edit-product-stock-unit-type" class="block text-sm font-medium text-gemini-gray-700">Stock Measurement Type</label>
                                <select id="edit-product-stock-unit-type" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" onchange="updateEditStockUnitHints()">
                                    <option value="units">Units</option>
                                    <option value="grams">Grams</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">Units: count by pieces. Grams: count by weight.</p>
                            </div>
                            <div>
                                <label for="edit-product-weight" class="block text-sm font-medium text-gemini-gray-700">Weight per Unit (g)</label>
                                <input type="number" id="edit-product-weight" value="0" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" placeholder="Grams per unit">
                                <p class="mt-1 text-xs text-gray-500">Only applies if stock is measured in units.</p>
                            </div>
                            <div>
                                <label for="edit-product-purchase-date" class="block text-sm font-medium text-gemini-gray-700">Purchase Date</label>
                                <input type="date" id="edit-product-purchase-date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            </div>
                            <div>
                                <label for="edit-product-exit-date" class="block text-sm font-medium text-gemini-gray-700">Exit Date</label>
                                <input type="date" id="edit-product-exit-date" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="closeEditProductModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Cancel
                            </button>
                            <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal for Multiple Sales -->
            <div id="addMultipleSalesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-semibold mb-4">Add Multiple Sales</h3>
                    <div id="multiple-sales-container" class="space-y-4 mb-4">
                        <!-- Las filas de ventas se agregar치n aqu칤 din치micamente -->
                    </div>
                    <div class="flex justify-between mb-4">
                        <button onclick="addSaleRow()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            + Add Row
                        </button>
                    </div>
                    <div class="mb-4">
                        <label for="multiple-sales-date" class="block text-sm font-medium text-gemini-gray-700">Common Date (DD-MM-YYYY) - Optional</label>
                        <input type="text" id="multiple-sales-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}" class="mt-1 block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue">
                        <p class="mt-1 text-xs text-gray-500">If specified, will apply to all sales. Leave empty for current date.</p>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeAddMultipleSalesModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Cancel
                        </button>
                        <button onclick="saveMultipleSales()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Save All Sales
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Notificaci칩n Global -->
    <div id="notification" class="hidden fixed bottom-10 right-10 bg-gemini-gray-900 text-white p-4 rounded-lg shadow-xl transition-all duration-300 opacity-0">
        <span id="notification-message"></span>
    </div>


    <!-- 4. JavaScript de la Aplicaci칩n -->
    <script>
        /* --- NAVEGACI칍N --- */
        
        let currentView = 'dashboard'; // Rastrear la vista actual
        
        function showView(viewId) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            // Quitar clase activa de todos los links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-gemini-blue-dark', 'font-medium', 'bg-gemini-blue-light');
            });
            
            // Show selected view
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            // Marcar link como activo
            const activeLink = document.querySelector(`.nav-link[onclick="showView('${viewId}')"]`);
            activeLink.classList.add('text-gemini-blue-dark', 'font-medium', 'bg-gemini-blue-light');

            currentView = viewId; // Update current view
            reloadDataInCurrentView(); // Load data
        }

        function reloadDataInCurrentView() {
            // Load view-specific data
            if (currentView === 'dashboard') {
                loadDashboardData();
            }
            if (currentView === 'inventory') {
                loadInventoryData();
            }
            if (currentView === 'mrp') {
                loadMrpData();
            }
            // Load finance data
            if (currentView === 'finanzas') {
                loadFinanzasData();
                loadSalesData();
            }
        }

        /* --- NOTIFICACI칍N --- */
        
        function showNotification(message) {
            const el = document.getElementById('notification');
            document.getElementById('notification-message').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('opacity-100'), 10); // Fade in
            setTimeout(() => {
                el.classList.remove('opacity-100');
                setTimeout(() => el.classList.add('hidden'), 500); // Fade out
            }, 3000);
        }

        /* --- L칍GICA DE INVENTARIO --- */
        
        let editingProductId = null;
        
        function updateStockUnitHints() {
            const stockUnitType = document.getElementById('product_stock_unit_type').value;
            const stockHint = document.getElementById('stock-unit-hint');
            const minStockHint = document.getElementById('min-stock-unit-hint');
            
            if (stockHint) {
                stockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 10 bolsas)' : 'En gramos (ej: 1000 g)';
            }
            if (minStockHint) {
                minStockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 5 bolsas)' : 'En gramos (ej: 500 g)';
            }
        }
        
        // Initialize hints on load
        document.addEventListener('DOMContentLoaded', function() {
            const stockUnitTypeSelect = document.getElementById('product_stock_unit_type');
            if (stockUnitTypeSelect) {
                stockUnitTypeSelect.addEventListener('change', updateStockUnitHints);
                updateStockUnitHints(); // Initialize
            }
        });

        document.getElementById('form-add-product').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // If we're editing, use the update function
            if (editingProductId !== null) {
                const name = document.getElementById('product_name').value;
                const type = document.getElementById('product_type').value;
                const cost = document.getElementById('product_cost').value;
                const stock = document.getElementById('product_stock').value;
                const min_stock = document.getElementById('product_min_stock').value;
                const supplier = document.getElementById('product_supplier').value || null;
                const purchase_date = document.getElementById('product_purchase_date').value || null;
                const exit_date = document.getElementById('product_exit_date').value || null;
                const sku = document.getElementById('product_sku').value || null;
                const weight = document.getElementById('product_weight').value || 0;
                const stock_unit_type = document.getElementById('product_stock_unit_type').value || 'units';
                const additional_cost = document.getElementById('product_additional_cost').value || 0;

                const result = await window.pywebview.api.update_product(editingProductId, name, type, stock, min_stock, cost, supplier, purchase_date, exit_date, sku, weight, stock_unit_type, additional_cost);
                showNotification(result.message);
                
                if (result.success) {
                    loadInventoryData();
                    e.target.reset();
                    editingProductId = null;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Save Product';
                }
                return;
            }

            // Si no, agregar nuevo producto
            const name = document.getElementById('product_name').value;
            const type = document.getElementById('product_type').value;
            const cost = document.getElementById('product_cost').value;
            const stock = document.getElementById('product_stock').value;
            const min_stock = document.getElementById('product_min_stock').value;
            const supplier = document.getElementById('product_supplier').value || null;
            const purchase_date = document.getElementById('product_purchase_date').value || null;
            const exit_date = document.getElementById('product_exit_date').value || null;
            const sku = document.getElementById('product_sku').value || null;
            const weight = document.getElementById('product_weight').value || 0;
            const stock_unit_type = document.getElementById('product_stock_unit_type').value || 'units';
            const additional_cost = document.getElementById('product_additional_cost').value || 0;

            // Llamada a la API de Python
            const result = await window.pywebview.api.add_product(name, type, stock, min_stock, cost, supplier, purchase_date, exit_date, sku, weight, stock_unit_type, additional_cost);
            
            if (result.success) {
                showNotification(result.message);
                loadInventoryData(); // Reload list
                e.target.reset(); // Clear form
            } else {
                showNotification(`Error: ${result.message}`);
            }
        });

        async function loadInventoryData() {
            // Llamada a la API de Python
            const result = await window.pywebview.api.load_products();
            
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            const products = result.data;

            const tbody = document.getElementById('product-list-body');
            tbody.innerHTML = ''; // Limpiar lista
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="16" class="px-6 py-4 text-center text-gemini-gray-700">No products in inventory.</td></tr>';
                return;
            }

            let totalStock = 0;
            let stockAlerts = 0;
            let totalValue = 0;

            products.forEach(p => {
                // Alerta de stock bajo
                let stockClass = 'text-gemini-gray-900';
                if (p.stock < p.min_stock) {
                    stockClass = 'text-red-600 font-bold';
                    stockAlerts++;
                }
                totalStock += p.stock;
                totalValue += p.stock * (p.cost || 0);

                // Format dates
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('es-ES');
                };

                tbody.innerHTML += `
                    <tr>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.id}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.sku || '-'}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.name}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.product_type}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">${p.supplier || '-'}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-1">
                                <span id="cost-display-${p.id}" class="text-sm">$ ${(p.cost || 0).toFixed(2)}</span>
                                <button onclick="editProductCost(${p.id})" class="text-xs bg-blue-500 text-white px-1 py-0.5 rounded hover:bg-blue-600" title="Edit cost">九勇</button>
                            </div>
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap font-semibold text-green-700 text-sm">
                            $ ${((p.stock || 0) * (p.cost || 0)).toFixed(2)}
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap ${stockClass} text-sm">
                            ${p.stock} ${p.stock_unit_type === 'units' ? 'unid.' : 'g'}
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">
                            ${p.min_stock} ${p.stock_unit_type === 'units' ? 'unid.' : 'g'}
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">${formatDate(p.purchase_date)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">${formatDate(p.exit_date)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${p.stock_unit_type === 'units' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                ${p.stock_unit_type === 'units' ? 'Unid.' : 'Gramos'}
                            </span>
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap text-sm">${(p.weight || 0).toFixed(2)}</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap font-semibold text-gemini-blue-dark text-sm">${(p.total_weight || 0).toFixed(2)} g</td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <form class="flex items-center space-x-1" onsubmit="adjustStock(event, ${p.id})">
                                <input id="adjust-stock-input-${p.id}" type="number" step="0.01" placeholder="${p.stock_unit_type === 'units' ? '췀' : '췀'}" class="w-16 md:w-20 block rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue text-xs">
                                <button type="submit" class="text-xs bg-gemini-blue text-white px-1.5 py-0.5 rounded-md hover:bg-gemini-blue-dark whitespace-nowrap">Ajustar</button>
                            </form>
                        </td>
                        <td class="px-3 md:px-6 py-3 md:py-4 whitespace-nowrap">
                            <div class="flex flex-col space-y-1">
                                <button onclick="showEditProductModal(${p.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-md hover:bg-yellow-600 whitespace-nowrap" title="Edit full product">九勇</button>
                                <button onclick="deleteProduct(${p.id}, '${p.name.replace(/'/g, "\\'")}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 whitespace-nowrap" title="Delete product">游딈勇</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            // Update dashboard KPIs (if elements exist)
            const kpiStock = document.getElementById('kpi-total-stock');
            const kpiValue = document.getElementById('kpi-inventory-value');

            if (kpiStock) kpiStock.textContent = totalStock;
            if (kpiValue) kpiValue.textContent = `$ ${totalValue.toFixed(2)}`;
            
            // Update products list with alerts
            updateStockAlertsList(products);
        }
        
        function updateStockAlertsList(products) {
            const alertsList = document.getElementById('stock-alerts-list');
            if (!alertsList) return;
            
            const productsWithAlerts = products.filter(p => p.stock < p.min_stock);
            
            if (productsWithAlerts.length === 0) {
                alertsList.innerHTML = '<p class="text-green-600 font-medium">九 No products with low stock alert.</p>';
                return;
            }
            
            alertsList.innerHTML = '';
            productsWithAlerts.forEach(p => {
                const stockPercent = p.min_stock > 0 ? ((p.stock / p.min_stock) * 100).toFixed(1) : 0;
                const unitLabel = p.stock_unit_type === 'units' ? 'unidades' : 'g';
                alertsList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200 hover:bg-red-100 transition-colors">
                        <div class="flex-1">
                            <div class="font-semibold text-red-800">${p.name}${p.sku ? ` [${p.sku}]` : ''}</div>
                            <div class="text-sm text-gray-600">
                                Stock actual: <span class="font-bold text-red-600">${p.stock} ${unitLabel}</span> | 
                                Stock m칤nimo: <span class="font-medium">${p.min_stock} ${unitLabel}</span>
                                ${p.min_stock > 0 ? `(${stockPercent}% del m칤nimo)` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-red-700 font-medium">Faltan ${(p.min_stock - p.stock).toFixed(2)} ${unitLabel}</div>
                            <button onclick="showEditProductModal(${p.id})" class="mt-1 text-xs bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // Function to adjust stock
        async function adjustStock(event, productId) {
            event.preventDefault();
            const inputEl = document.getElementById(`adjust-stock-input-${productId}`);
            const quantityChange = inputEl.value;

            if (!quantityChange || quantityChange == 0) {
                showNotification("Por favor, introduce una cantidad para ajustar.");
                return;
            }

            const result = await window.pywebview.api.adjust_inventory(productId, quantityChange);
            showNotification(result.message);
            
            if (result.success) {
                loadInventoryData(); // Reload list de inventario
            }
        }

        // Function to edit product (old version - keep for compatibility)
        async function editProduct(productId) {
            showEditProductModal(productId);
        }
        
        // Function to show product edit modal
        async function showEditProductModal(productId) {
            const result = await window.pywebview.api.load_products();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const product = result.data.find(p => p.id === productId);
            if (!product) {
                showNotification("Producto no encontrado");
                return;
            }

            // Llenar el formulario del modal con los datos del producto
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-sku').value = product.sku || '';
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-type').value = product.product_type;
            document.getElementById('edit-product-supplier').value = product.supplier || '';
            document.getElementById('edit-product-cost').value = product.cost || 0;
            document.getElementById('edit-product-stock').value = product.stock || 0;
            document.getElementById('edit-product-min-stock').value = product.min_stock || 0;
            document.getElementById('edit-product-purchase-date').value = product.purchase_date || '';
            document.getElementById('edit-product-exit-date').value = product.exit_date || '';
            document.getElementById('edit-product-weight').value = product.weight || 0;
            document.getElementById('edit-product-stock-unit-type').value = product.stock_unit_type || 'units';
            document.getElementById('edit-product-additional-cost').value = product.additional_cost || 0;
            
            // Update hints
            updateEditStockUnitHints();

            // Show modal
            document.getElementById('editProductModal').classList.remove('hidden');
        }
        
        function closeEditProductModal() {
            document.getElementById('editProductModal').classList.add('hidden');
            document.getElementById('form-edit-product').reset();
        }
        
        function updateEditStockUnitHints() {
            const stockUnitType = document.getElementById('edit-product-stock-unit-type').value;
            const stockHint = document.getElementById('edit-stock-unit-hint');
            const minStockHint = document.getElementById('edit-min-stock-unit-hint');
            
            if (stockHint) {
                stockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 10 bolsas)' : 'En gramos (ej: 1000 g)';
            }
            if (minStockHint) {
                minStockHint.textContent = stockUnitType === 'units' ? 'En unidades (ej: 5 bolsas)' : 'En gramos (ej: 500 g)';
            }
        }
        
        // Function to calculate cost from BOM (main form)
        async function calculateCostFromBOM() {
            // We need the product ID, but in the add form we don't have it yet
            // We can only calculate if we're editing
            if (editingProductId === null) {
                showNotification('First save the product and define its BOM, then you can calculate the cost automatically.');
                return;
            }
            
            const result = await window.pywebview.api.calculate_bom_cost(editingProductId);
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const data = result.data;
            if (data.components.length === 0) {
                showNotification('Este producto no tiene componentes en el BOM. Agrega componentes primero.');
                return;
            }
            
            // Update calculated cost
            document.getElementById('product_cost').value = data.calculated_cost.toFixed(2);
            document.getElementById('product_additional_cost').value = data.additional_cost.toFixed(2);
            
            // Show breakdown
            let breakdown = `Costo calculado: $${data.calculated_cost.toFixed(2)}\n`;
            breakdown += `Materiales: $${data.materials_cost.toFixed(2)}\n`;
            breakdown += `Adicional: $${data.additional_cost.toFixed(2)}\n\n`;
            breakdown += 'Desglose por componente:\n';
            data.components.forEach(comp => {
                breakdown += `- ${comp.component_name}: $${comp.total_cost.toFixed(2)} (${comp.required_quantity} ${comp.unit_type})\n`;
            });
            
            showNotification(breakdown);
        }
        
        // Function to calculate cost from BOM (edit modal)
        async function calculateCostFromBOMEdit() {
            const productId = document.getElementById('edit-product-id').value;
            if (!productId) {
                showNotification('Error: Product ID not found.');
                return;
            }
            
            const result = await window.pywebview.api.calculate_bom_cost(productId);
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const data = result.data;
            if (data.components.length === 0) {
                showNotification('Este producto no tiene componentes en el BOM. Agrega componentes primero.');
                return;
            }
            
            // Update calculated cost
            document.getElementById('edit-product-cost').value = data.calculated_cost.toFixed(2);
            document.getElementById('edit-product-additional-cost').value = data.additional_cost.toFixed(2);
            
            // Show breakdown
            let breakdown = `Costo calculado: $${data.calculated_cost.toFixed(2)}\n`;
            breakdown += `Materiales: $${data.materials_cost.toFixed(2)}\n`;
            breakdown += `Adicional: $${data.additional_cost.toFixed(2)}\n\n`;
            breakdown += 'Desglose por componente:\n';
            data.components.forEach(comp => {
                breakdown += `- ${comp.component_name}: $${comp.total_cost.toFixed(2)} (${comp.required_quantity} ${comp.unit_type})\n`;
            });
            
            showNotification(breakdown);
        }
        
        // Event listener for edit form
        document.getElementById('form-edit-product').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('edit-product-id').value;
            const name = document.getElementById('edit-product-name').value;
            const type = document.getElementById('edit-product-type').value;
            const cost = document.getElementById('edit-product-cost').value;
            const stock = document.getElementById('edit-product-stock').value;
            const min_stock = document.getElementById('edit-product-min-stock').value;
            const supplier = document.getElementById('edit-product-supplier').value || null;
            const purchase_date = document.getElementById('edit-product-purchase-date').value || null;
            const exit_date = document.getElementById('edit-product-exit-date').value || null;
            const sku = document.getElementById('edit-product-sku').value || null;
            const weight = document.getElementById('edit-product-weight').value || 0;
            const stock_unit_type = document.getElementById('edit-product-stock-unit-type').value || 'units';
            const additional_cost = document.getElementById('edit-product-additional-cost').value || 0;

            const result = await window.pywebview.api.update_product(productId, name, type, stock, min_stock, cost, supplier, purchase_date, exit_date, sku, weight, stock_unit_type, additional_cost);
            showNotification(result.message);
            
            if (result.success) {
                loadInventoryData();
                closeEditProductModal();
            }
        });

        // Function to delete product
        async function deleteProduct(productId, productName) {
            if (!confirm(`Are you sure you want to delete the product "${productName}"?`)) {
                return;
            }

            const result = await window.pywebview.api.delete_product(productId);
            showNotification(result.message);
            
            if (result.success) {
                loadInventoryData();
            }
        }

        // Function to quickly edit unit cost
        async function editProductCost(productId) {
            const result = await window.pywebview.api.load_products();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const product = result.data.find(p => p.id === productId);
            if (!product) {
                showNotification("Producto no encontrado");
                return;
            }

            const newCost = prompt(`Edit unit cost of "${product.name}":`, product.cost || 0);
            if (newCost === null) return; // User cancelled

            const costValue = parseFloat(newCost);
            if (isNaN(costValue) || costValue < 0) {
                showNotification("Por favor, ingresa un valor num칠rico v치lido mayor o igual a 0");
                return;
            }

            // Update only cost using update_product
            const updateResult = await window.pywebview.api.update_product(
                productId, 
                product.name, 
                product.product_type, 
                product.stock, 
                product.min_stock, 
                costValue,
                product.supplier,
                product.purchase_date,
                product.exit_date,
                product.sku,
                product.weight || 0,
                product.stock_unit_type || 'units'
            );
            
            showNotification(updateResult.message);
            
            if (updateResult.success) {
                loadInventoryData(); // Reload list
            }
        }

        /* --- L칍GICA DEL DASHBOARD --- */
        
        let kpiChartInstance = null;
        let topSalesChartInstance = null;
        let costBreakdownChartInstance = null;
        let inventoryValuationChartInstance = null;
        let currentPeriod = 'month';
        
        async function loadDashboardData(period = 'month') {
            currentPeriod = period;

            // Load basic financial data
            const result = await window.pywebview.api.get_kpi_data(period);
            if (!result.success) {
                showNotification(`Error loading KPIs: ${result.message}`);
                return;
            }
            
            const data = result.data;

            // 1. Update inventory KPIs
            const kpis = data.inventory_kpis;
            const kpiStock = document.getElementById('kpi-total-stock');
            const kpiValue = document.getElementById('kpi-inventory-value');

            if (kpiStock) kpiStock.textContent = kpis.total_stock_items;
            if (kpiValue) kpiValue.textContent = `$ ${kpis.total_inventory_value.toFixed(2)}`;
            
            // Load products to show alerts
            const productsResult = await window.pywebview.api.load_products();
            if (productsResult.success) {
                updateStockAlertsList(productsResult.data);
            }

            // 2. Update Financial Chart with Profits
            const financeData = data.financial_summary;
            const ctx = document.getElementById('kpiChart').getContext('2d');
            
            if (kpiChartInstance) {
                kpiChartInstance.destroy();
            }
            
            kpiChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: financeData.labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: financeData.revenue,
                            borderColor: '#4285f4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Costos',
                            data: financeData.costs,
                            borderColor: '#ea4335',
                            backgroundColor: 'rgba(234, 67, 53, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Utilidades',
                            data: financeData.profit || [],
                            borderColor: '#34a853',
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 3. Load BI data
            await loadBIDashboardData();
        }

        async function loadBIDashboardData() {
            const result = await window.pywebview.api.get_bi_dashboard_data();
            if (!result.success) {
                console.error('Error loading BI data:', result.message);
                return;
            }

            const biData = result.data;

            // Update financial metrics
            const metrics = biData.financial_metrics;
            const profitMarginEl = document.getElementById('kpi-profit-margin');
            const avgTicketEl = document.getElementById('kpi-avg-ticket');
            const salesCountEl = document.getElementById('kpi-sales-count');
            const monthProfitEl = document.getElementById('kpi-month-profit');

            if (profitMarginEl) profitMarginEl.textContent = `${metrics.profit_margin}%`;
            if (avgTicketEl) avgTicketEl.textContent = `$ ${metrics.avg_ticket.toFixed(2)}`;
            if (salesCountEl) salesCountEl.textContent = metrics.sales_count;
            if (monthProfitEl) monthProfitEl.textContent = `$ ${metrics.profit.toFixed(2)}`;

            // Top 5 Best Selling Products (Horizontal Bar Chart)
            const topSalesCtx = document.getElementById('topSalesChart').getContext('2d');
            if (topSalesChartInstance) {
                topSalesChartInstance.destroy();
            }
            
            const topSales = biData.top_sales;
            topSalesChartInstance = new Chart(topSalesCtx, {
                type: 'bar',
                data: {
                    labels: topSales.map(p => p.product_name),
                    datasets: [{
                        label: 'Cantidad Vendida',
                        data: topSales.map(p => p.total_quantity),
                        backgroundColor: '#4285f4'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Top 5 Most Profitable Products (List)
            const topProfitList = document.getElementById('topProfitabilityList');
            topProfitList.innerHTML = '';
            biData.top_profitability.forEach((p, index) => {
                topProfitList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gemini-gray-100 rounded-lg">
                        <div>
                            <div class="font-semibold">${index + 1}. ${p.product_name}</div>
                            <div class="text-sm text-gray-600">Utilidad: $ ${(p.total_profit || 0).toFixed(2)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">$ ${(p.total_profit || 0).toFixed(2)}</div>
                            <div class="text-xs text-gray-500">${p.total_quantity} unidades</div>
                        </div>
                    </div>
                `;
            });

            // Cost Breakdown by Category (Donut Chart)
            const costBreakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
            if (costBreakdownChartInstance) {
                costBreakdownChartInstance.destroy();
            }
            
            const costBreakdown = biData.cost_breakdown;
            const colors = ['#ea4335', '#fbbc04', '#34a853', '#4285f4', '#9aa0a6'];
            costBreakdownChartInstance = new Chart(costBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: costBreakdown.map(c => c.category),
                    datasets: [{
                        data: costBreakdown.map(c => c.total),
                        backgroundColor: colors.slice(0, costBreakdown.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Inventory Valuation by Category
            const inventoryValuationCtx = document.getElementById('inventoryValuationChart').getContext('2d');
            if (inventoryValuationChartInstance) {
                inventoryValuationChartInstance.destroy();
            }
            
            const inventoryValuation = biData.inventory_valuation;
            inventoryValuationChartInstance = new Chart(inventoryValuationCtx, {
                type: 'bar',
                data: {
                    labels: inventoryValuation.map(v => v.product_type),
                    datasets: [{
                        label: 'Valor Total',
                        data: inventoryValuation.map(v => v.total_value || 0),
                        backgroundColor: '#4285f4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Productos Sin Movimiento
            const productsNoMovementList = document.getElementById('productsNoMovementList');
            productsNoMovementList.innerHTML = '';
            if (biData.products_no_movement.length === 0) {
                productsNoMovementList.innerHTML = '<p class="text-gray-500">No products without movement.</p>';
            } else {
                biData.products_no_movement.forEach(p => {
                    productsNoMovementList.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div>
                                <div class="font-semibold">${p.name}</div>
                                <div class="text-sm text-gray-600">Stock: ${p.stock} | Valor: $ ${(p.total_value || 0).toFixed(2)}</div>
                            </div>
                            <div class="text-xs text-yellow-700">Sin movimiento</div>
                        </div>
                    `;
                });
            }
        }
        
        // Listener for period selector (initialized when DOM is ready)
        function initPeriodSelector() {
            const periodSelector = document.getElementById('period-selector');
            if (periodSelector) {
                periodSelector.addEventListener('change', function() {
                    loadDashboardData(this.value);
                });
            }
        }

        /* --- L칍GICA DE MRP y BOM --- */

        async function loadMrpData() {
            // Load product <select> elements
            const parentSelect = document.getElementById('mrp-select-parent');
            const childSelect = document.getElementById('mrp-select-child');
            const calculateSelect = document.getElementById('mrp-calculate-product');

            // Load ALL products for both selectors
            // Cualquier producto puede ser padre o hijo
            const allProductsResult = await window.pywebview.api.load_products();
            
            parentSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            childSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            if (calculateSelect) {
                calculateSelect.innerHTML = '<option value="">Selecciona un producto...</option>';
            }
            
            if (allProductsResult.success) {
                allProductsResult.data.forEach(p => {
                    const skuText = p.sku ? ` [${p.sku}]` : '';
                    const typeText = ` (${p.product_type})`;
                    const optionText = `${p.name}${skuText}${typeText}`;
                    parentSelect.innerHTML += `<option value="${p.id}">${optionText}</option>`;
                    childSelect.innerHTML += `<option value="${p.id}">${optionText}</option>`;
                    if (calculateSelect) {
                        calculateSelect.innerHTML += `<option value="${p.id}">${optionText}</option>`;
                    }
                });
            }
        }
        
        async function calculateMRP() {
            const productId = document.getElementById('mrp-calculate-product').value;
            if (!productId) {
                showNotification('Please select a product to calculate.');
                return;
            }
            
            const result = await window.pywebview.api.calculate_mrp_production(productId);
            const resultDiv = document.getElementById('mrp-result');
            
            if (!result.success) {
                resultDiv.innerHTML = `<p class="text-red-600">Error: ${result.message}</p>`;
                resultDiv.classList.remove('hidden');
                return;
            }
            
            const data = result.data;
            let html = `<h4 class="font-semibold text-lg mb-2">Resultado del C치lculo MRP</h4>`;
            html += `<p class="mb-4 text-green-700 font-medium">${data.message}</p>`;
            
            if (data.components && data.components.length > 0) {
                html += `<div class="mt-4"><h5 class="font-semibold mb-2">Componentes Necesarios:</h5>`;
                html += `<table class="min-w-full divide-y divide-gray-200">`;
                html += `<thead class="bg-gray-50"><tr>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Componente</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Cantidad Requerida</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Stock Disponible</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Tipo</th>`;
                html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-700">Puede Producir</th>`;
                html += `</tr></thead><tbody>`;
                
                data.components.forEach(comp => {
                    const child_unit_type = comp.child_stock_unit_type || 'units';
                    const unit_label = child_unit_type === 'units' ? 'unidades' : 'g';
                    
                    // Calculate how many can be produced
                    let canProduce;
                    if (child_unit_type === 'units') {
                        canProduce = Math.floor(comp.child_stock / comp.required_quantity);
                    } else {
                        canProduce = comp.child_stock / comp.required_quantity;
                    }
                    
                    const isLimiting = data.limiting_component && data.limiting_component.bom_id === comp.bom_id;
                    const rowClass = isLimiting ? 'bg-yellow-50' : '';
                    html += `<tr class="${rowClass}">`;
                    html += `<td class="px-4 py-2">${comp.child_name}${comp.child_sku ? ` [${comp.child_sku}]` : ''}</td>`;
                    html += `<td class="px-4 py-2">${comp.required_quantity} ${unit_label}</td>`;
                    html += `<td class="px-4 py-2">${comp.child_stock} ${unit_label}</td>`;
                    html += `<td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded-full ${child_unit_type === 'units' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${child_unit_type === 'units' ? 'Unidades' : 'Gramos'}</span></td>`;
                    html += `<td class="px-4 py-2 font-semibold">${canProduce.toFixed(2)} ${isLimiting ? '丘멆잺 (Limitante)' : ''}</td>`;
                    html += `</tr>`;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += `<p class="text-gray-600">Stock actual disponible: ${data.can_produce || 0}</p>`;
            }
            
            resultDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Show production controls if units can be produced
            const productionControls = document.getElementById('mrp-production-controls');
            if (data.can_produce > 0) {
                document.getElementById('mrp-production-quantity').max = data.can_produce;
                document.getElementById('mrp-production-quantity').value = data.can_produce;
                productionControls.classList.remove('hidden');
            } else {
                productionControls.classList.add('hidden');
            }
        }
        
        async function executeProduction() {
            const productId = document.getElementById('mrp-calculate-product').value;
            const quantity = document.getElementById('mrp-production-quantity').value;
            
            if (!productId || !quantity || quantity <= 0) {
                showNotification('Por favor, selecciona un producto y especifica una cantidad v치lida.');
                return;
            }
            
            if (!confirm(`Are you sure you want to produce ${quantity} units? This will reduce component stock and increase final product stock.`)) {
                return;
            }
            
            const result = await window.pywebview.api.execute_production(productId, quantity);
            showNotification(result.message);
            
            if (result.success) {
                // Recalculate MRP to update values
                await calculateMRP();
                // Reload inventory if we're on that view
                if (currentView === 'inventory') {
                    loadInventoryData();
                }
            }
        }

        // Event listener para cuando se selecciona un producto padre
        document.getElementById('mrp-select-parent').addEventListener('change', async function() {
            const parentId = this.value;
            if (!parentId) {
                document.getElementById('mrp-bom-list').innerHTML = '';
                return;
            }
            // Load BOM for this product
            loadBomList(parentId);
        });

        async function loadBomList(parentId) {
            const bomResult = await window.pywebview.api.get_bom(parentId);
            const bomListEl = document.getElementById('mrp-bom-list');
            bomListEl.innerHTML = '';
            
            if (bomResult.success && bomResult.data.length > 0) {
                bomResult.data.forEach(item => {
                    bomListEl.innerHTML += `
                        <li class="flex justify-between items-center mb-1">
                            <span>${item.child_product_name} (x${item.quantity})</span>
                            <button onclick="deleteBomEntry(${item.bom_id})" class="text-red-500 hover:text-red-700 text-xs">Delete</button>
                        </li>
                    `;
                });
            } else {
                bomListEl.innerHTML = '<li>No components defined for this product.</li>';
            }
        }

        // Event listener to add a component to BOM
        document.getElementById('form-add-bom').addEventListener('submit', async function(e) {
            e.preventDefault();
            const parentId = document.getElementById('mrp-select-parent').value;
            const childId = document.getElementById('mrp-select-child').value;
            const quantity = document.getElementById('mrp-child-quantity').value;

            if (!parentId || !childId) {
                showNotification('Error: You must select a parent product and a component.');
                return;
            }
            
            // Prevenir que un producto sea su propio hijo
            if (parentId === childId) {
                showNotification('Error: A product cannot be a component of itself.');
                return;
            }

            const result = await window.pywebview.api.add_bom_entry(parentId, childId, quantity);
            showNotification(result.message);
            
            if (result.success) {
                loadBomList(parentId); // Reload BOM list
                // Reset add form
                document.getElementById('mrp-select-child').value = '';
                document.getElementById('mrp-child-quantity').value = '1';
            }
        });

        async function deleteBomEntry(bomId) {
            const parentId = document.getElementById('mrp-select-parent').value;
            const result = await window.pywebview.api.delete_bom_entry(bomId);
            showNotification(result.message);
            if (result.success && parentId) {
                loadBomList(parentId); // Reload list
            }
        }


        /* --- L칍GICA DE FINANZAS --- */

        let showingAllFinances = false;

        async function loadFinanzasData() {
            showingAllFinances = false;
            const result = await window.pywebview.api.get_recent_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            renderFinances(result.data);
        }

        async function loadAllFinances() {
            showingAllFinances = true;
            const result = await window.pywebview.api.get_all_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            renderFinances(result.data);
        }

        function renderFinances(data) {
            const { revenue, costs } = data;
            
            // Formatear fecha
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('es-ES');
            };
            
            // Rellenar lista de ingresos
            const revenueListEl = document.getElementById('recent-revenue-list');
            revenueListEl.innerHTML = '';
            if (revenue.length > 0) {
                revenue.forEach(item => {
                    revenueListEl.innerHTML += `
                        <li class="py-2 flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-medium">${item.description}</div>
                                <div class="text-xs text-gray-500">${formatDate(item.date)}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-green-700">$ ${item.amount.toFixed(2)}</span>
                                <button onclick="editRevenue(${item.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Edit</button>
                                <button onclick="deleteRevenue(${item.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                            </div>
                        </li>
                    `;
                });
            } else {
                revenueListEl.innerHTML = '<li class="py-2 text-gray-500">No revenue entries.</li>';
            }

            // Rellenar lista de costos
            const costsListEl = document.getElementById('recent-costs-list');
            costsListEl.innerHTML = '';
            if (costs.length > 0) {
                costs.forEach(item => {
                    costsListEl.innerHTML += `
                        <li class="py-2 flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-medium">${item.description}</div>
                                <div class="text-xs text-gray-500">${formatDate(item.date)} | ${item.category || 'Otros'}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-red-700">$ ${item.amount.toFixed(2)}</span>
                                <button onclick="editCost(${item.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Edit</button>
                                <button onclick="deleteCost(${item.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                            </div>
                        </li>
                    `;
                });
            } else {
                costsListEl.innerHTML = '<li class="py-2 text-gray-500">No hay costos.</li>';
            }
        }

        async function editRevenue(revenueId) {
            const result = await window.pywebview.api.get_all_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const revenue = result.data.revenue.find(r => r.id === revenueId);
            if (!revenue) {
                showNotification("Ingreso no encontrado");
                return;
            }

            const description = prompt("Descripci칩n:", revenue.description);
            if (description === null) return;

            const amount = prompt("Monto:", revenue.amount);
            if (amount === null) return;

            const date = prompt("Fecha (YYYY-MM-DD, dejar vac칤o para mantener):", revenue.date ? revenue.date.split('T')[0] : '');
            const finalDate = date === '' ? null : date;

            const updateResult = await window.pywebview.api.update_revenue_entry(revenueId, description, amount, finalDate);
            showNotification(updateResult.message);
            
            if (updateResult.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        async function editCost(costId) {
            const result = await window.pywebview.api.get_all_finances();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const cost = result.data.costs.find(c => c.id === costId);
            if (!cost) {
                showNotification("Costo no encontrado");
                return;
            }

            const description = prompt("Descripci칩n:", cost.description);
            if (description === null) return;

            const amount = prompt("Monto:", cost.amount);
            if (amount === null) return;

            const category = prompt("Categor칤a (Materia Prima, Log칤stica, Sueldos, Servicios, Otros):", cost.category || 'Otros');
            if (category === null) return;

            const date = prompt("Fecha (YYYY-MM-DD, dejar vac칤o para mantener):", cost.date ? cost.date.split('T')[0] : '');
            const finalDate = date === '' ? null : date;

            const updateResult = await window.pywebview.api.update_cost_entry(costId, description, amount, finalDate, category);
            showNotification(updateResult.message);
            
            if (updateResult.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        async function deleteRevenue(revenueId) {
            if (!confirm("Are you sure you want to delete this revenue entry?")) {
                return;
            }

            const result = await window.pywebview.api.delete_revenue_entry(revenueId);
            showNotification(result.message);
            
            if (result.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        async function deleteCost(costId) {
            if (!confirm("Are you sure you want to delete this cost entry?")) {
                return;
            }

            const result = await window.pywebview.api.delete_cost_entry(costId);
            showNotification(result.message);
            
            if (result.success) {
                if (showingAllFinances) {
                    loadAllFinances();
                } else {
                    loadFinanzasData();
                }
            }
        }

        // Function to convert DD-MM-YYYY to YYYY-MM-DD
        function convertDateFormat(dateStr) {
            if (!dateStr || dateStr.trim() === '') return null;
            const parts = dateStr.split('-');
            if (parts.length === 3 && parts[0].length === 2 && parts[1].length === 2 && parts[2].length === 4) {
                // Format DD-MM-YYYY
                return `${parts[2]}-${parts[1]}-${parts[0]}`; // Convert to YYYY-MM-DD
            }
            return null;
        }

        // Listener for Revenue form
        document.getElementById('form-add-revenue').addEventListener('submit', async function(e) {
            e.preventDefault();
            const description = document.getElementById('revenue-description').value;
            const amount = document.getElementById('revenue-amount').value;
            const dateInput = document.getElementById('revenue-date').value;
            const date = convertDateFormat(dateInput);
            
            const result = await window.pywebview.api.add_revenue_entry(description, amount, date);
            showNotification(result.message);
            
            if (result.success) {
                loadFinanzasData(); // Reload lists
                e.target.reset(); // Clear form
            }
        });

        // Listener for Costs form
        document.getElementById('form-add-cost').addEventListener('submit', async function(e) {
            e.preventDefault();
            const description = document.getElementById('cost-description').value;
            const amount = document.getElementById('cost-amount').value;
            const category = document.getElementById('cost-category').value;
            const dateInput = document.getElementById('cost-date').value;
            const date = convertDateFormat(dateInput);
            
            const result = await window.pywebview.api.add_cost_entry(description, amount, date, category);
            showNotification(result.message);
            
            if (result.success) {
                loadFinanzasData(); // Reload lists
                e.target.reset(); // Clear form
            }
        });


        /* --- SALES LOGIC --- */
        
        let saleRowCounter = 0;
        
        function addSaleRow() {
            saleRowCounter++;
            const container = document.getElementById('multiple-sales-container');
            const row = document.createElement('div');
            row.className = 'border rounded-lg p-4 bg-gray-50 relative';
            row.id = `sale-row-${saleRowCounter}`;
            row.innerHTML = `
                <button onclick="removeSaleRow(${saleRowCounter})" class="absolute top-2 right-2 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 rounded-full p-1.5 transition-colors" title="Remove this row">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pr-8">
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Product</label>
                        <select class="sale-row-product block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" required>
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Quantity</label>
                        <input type="number" class="sale-row-quantity block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Unit Price</label>
                        <input type="number" class="sale-row-price block w-full rounded-md border-gemini-gray-300 shadow-sm focus:border-gemini-blue focus:ring-gemini-blue" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gemini-gray-700 mb-1">Total</label>
                        <input type="text" class="sale-row-total block w-full rounded-md border-gemini-gray-300 shadow-sm bg-gray-100" readonly>
                    </div>
                </div>
            `;
            container.appendChild(row);
            
            // Load products in select
            loadProductsForMultipleSales(row.querySelector('.sale-row-product'));
            
            // Add listeners to calculate total
            const quantityInput = row.querySelector('.sale-row-quantity');
            const priceInput = row.querySelector('.sale-row-price');
            const totalInput = row.querySelector('.sale-row-total');
            
            function updateTotal() {
                const qty = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = `$ ${(qty * price).toFixed(2)}`;
            }
            
            quantityInput.addEventListener('input', updateTotal);
            priceInput.addEventListener('input', updateTotal);
        }
        
        function removeSaleRow(rowId) {
            const row = document.getElementById(`sale-row-${rowId}`);
            if (row) {
                // Confirm if there's more than one row
                const container = document.getElementById('multiple-sales-container');
                if (container.children.length > 1) {
                    row.remove();
                } else {
                    showNotification('There must be at least one row. If you want to delete everything, cancel and reopen the modal.');
                }
            }
        }
        
        async function loadProductsForMultipleSales(selectElement) {
            const result = await window.pywebview.api.load_products();
            if (result.success) {
                result.data.forEach(p => {
                    const skuText = p.sku ? ` [${p.sku}]` : '';
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name}${skuText} (${p.product_type})`;
                    option.setAttribute('data-name', p.name);
                    selectElement.appendChild(option);
                });
            }
        }
        
        function showAddMultipleSalesModal() {
            document.getElementById('addMultipleSalesModal').classList.remove('hidden');
            document.getElementById('multiple-sales-container').innerHTML = '';
            saleRowCounter = 0;
            addSaleRow(); // Add first row by default
        }
        
        function closeAddMultipleSalesModal() {
            document.getElementById('addMultipleSalesModal').classList.add('hidden');
            document.getElementById('multiple-sales-container').innerHTML = '';
            document.getElementById('multiple-sales-date').value = '';
        }
        
        async function saveMultipleSales() {
            const container = document.getElementById('multiple-sales-container');
            const rows = container.querySelectorAll('[id^="sale-row-"]');
            const commonDate = document.getElementById('multiple-sales-date').value;
            const date = convertDateFormat(commonDate);
            
            if (rows.length === 0) {
                showNotification('Please add at least one sale.');
                return;
            }
            
            const salesList = [];
            let hasError = false;
            
            for (const row of rows) {
                const productSelect = row.querySelector('.sale-row-product');
                const quantityInput = row.querySelector('.sale-row-quantity');
                const priceInput = row.querySelector('.sale-row-price');
                
                const productId = productSelect.value;
                const productOption = productSelect.options[productSelect.selectedIndex];
                const productName = productOption.getAttribute('data-name');
                const quantity = quantityInput.value;
                const unitPrice = priceInput.value;
                
                if (!productId || !quantity || !unitPrice) {
                    hasError = true;
                    continue;
                }
                
                salesList.push({
                    product_id: parseInt(productId),
                    product_name: productName,
                    quantity: parseFloat(quantity),
                    unit_price: parseFloat(unitPrice),
                    date: date
                });
            }
            
            if (hasError) {
                showNotification('Please complete all fields in all rows.');
                return;
            }
            
            if (salesList.length === 0) {
                showNotification('No valid sales to save.');
                return;
            }
            
            const result = await window.pywebview.api.add_multiple_sales(salesList);
            showNotification(result.message);
            
            if (result.success) {
                closeAddMultipleSalesModal();
                loadSalesData();
                if (currentView === 'dashboard') {
                    loadDashboardData(currentPeriod);
                }
                if (currentView === 'finanzas') {
                    loadFinanzasData();
                }
            }
        }
        
        async function loadSalesData() {
            const result = await window.pywebview.api.get_all_sales();
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const sales = result.data;
            const tbody = document.getElementById('sales-list-body');
            tbody.innerHTML = '';
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No sales registered.</td></tr>';
                return;
            }
            
            sales.forEach(s => {
                const date = s.date ? new Date(s.date).toLocaleDateString('en-US') : '-';
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap">${date}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${s.product_name}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${s.quantity}</td>
                        <td class="px-4 py-3 whitespace-nowrap">$ ${s.unit_price.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-semibold">$ ${s.total_amount.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button onclick="editSale(${s.id})" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 mr-1">Edit</button>
                            <button onclick="deleteSale(${s.id})" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function deleteSale(saleId) {
            if (!confirm("Are you sure you want to delete this sale?")) {
                return;
            }
            
            const result = await window.pywebview.api.delete_sale(saleId);
            showNotification(result.message);
            
            if (result.success) {
                loadSalesData();
                if (currentView === 'dashboard') {
                    loadDashboardData(currentPeriod);
                }
            }
        }

        let editingSaleId = null;

        function showAddSaleModal() {
            editingSaleId = null;
            document.getElementById('sale-modal-title').textContent = 'New Sale';
            document.getElementById('sale-id').value = '';
            document.getElementById('addSaleModal').classList.remove('hidden');
            loadProductsForSale();
            document.getElementById('form-add-sale').reset();
        }

        async function editSale(saleId) {
            editingSaleId = saleId;
            const result = await window.pywebview.api.get_sale_by_id(saleId);
            if (!result.success) {
                showNotification(`Error: ${result.message}`);
                return;
            }
            
            const sale = result.data;
            document.getElementById('sale-modal-title').textContent = 'Edit Sale';
            document.getElementById('sale-id').value = sale.id;
            document.getElementById('sale-quantity').value = sale.quantity;
            document.getElementById('sale-unit-price').value = sale.unit_price;
            
            // Format date for input
            if (sale.date) {
                const date = new Date(sale.date);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                document.getElementById('sale-date').value = `${day}-${month}-${year}`;
            }
            
            // Load products and select the correct one
            await loadProductsForSale();
            document.getElementById('sale-product').value = sale.product_id;
            
            document.getElementById('addSaleModal').classList.remove('hidden');
        }

        function closeAddSaleModal() {
            document.getElementById('addSaleModal').classList.add('hidden');
            document.getElementById('form-add-sale').reset();
            editingSaleId = null;
        }

        async function loadProductsForSale() {
            // Load all products for sales (any product can be sold)
            const result = await window.pywebview.api.load_products();
            const select = document.getElementById('sale-product');
            select.innerHTML = '<option value="">Select a product...</option>';
            
            if (result.success) {
                result.data.forEach(p => {
                    const skuText = p.sku ? ` [${p.sku}]` : '';
                    select.innerHTML += `<option value="${p.id}" data-name="${p.name}">${p.name}${skuText} (${p.product_type})</option>`;
                });
            }
        }

        document.getElementById('form-add-sale').addEventListener('submit', async function(e) {
            e.preventDefault();
            const saleId = document.getElementById('sale-id').value;
            const productId = document.getElementById('sale-product').value;
            const productOption = document.getElementById('sale-product').options[document.getElementById('sale-product').selectedIndex];
            const productName = productOption.getAttribute('data-name');
            const quantity = document.getElementById('sale-quantity').value;
            const unitPrice = document.getElementById('sale-unit-price').value;
            const dateInput = document.getElementById('sale-date').value;
            const date = convertDateFormat(dateInput);
            
            if (!productId || !quantity || !unitPrice) {
                showNotification("Please complete all fields.");
                return;
            }
            
            let result;
            if (editingSaleId) {
                // Update existing sale
                result = await window.pywebview.api.update_sale(editingSaleId, productId, productName, quantity, unitPrice, date);
            } else {
                // Create new sale
                result = await window.pywebview.api.add_sale(productId, productName, quantity, unitPrice, date);
            }
            
            showNotification(result.message);
            
            if (result.success) {
                loadSalesData();
                closeAddSaleModal();
                if (currentView === 'dashboard') {
                    loadDashboardData(currentPeriod);
                }
                if (currentView === 'finanzas') {
                    loadFinanzasData();
                }
            }
        });

        /* --- EXCEL EXPORT LOGIC --- */
        
        async function exportToExcel() {
            showNotification('Starting Excel export...');
            window.pywebview.api.export_to_excel();
        }
        
        async function exportSalesReport(period) {
            showNotification(`Exporting sales report (${period})...`);
            const result = await window.pywebview.api.export_sales_report(period);
            if (result.success) {
                // File will be saved and notified from Python
            }
            toggleSalesReportMenu(); // Cerrar men칰
        }
        
        function toggleSalesReportMenu() {
            const menu = document.getElementById('salesReportMenu');
            menu.classList.toggle('hidden');
        }
        
        // Cerrar men칰 al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('salesReportMenu');
            const button = event.target.closest('button[onclick="toggleSalesReportMenu()"]');
            if (menu && !button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
        
        async function openLastExcelFile() {
            const result = await window.pywebview.api.open_excel_file();
            if (result.success) {
                showNotification('Abriendo archivo Excel...');
            } else {
                showNotification(result.message || 'No se encontr칩 un archivo Excel reciente. Exporta primero un archivo.');
            }
        }

        /* --- INICIO --- */
        
        // Cargar la vista inicial (Dashboard) al iniciar
        window.addEventListener('pywebviewready', () => {
            initPeriodSelector(); // Inicializar selector de per칤odo
            showView('dashboard');
        });

    </script>
</body>
</html>